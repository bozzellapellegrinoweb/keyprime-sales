import React, { useState, useEffect } from 'react';
import { createClient } from '@supabase/supabase-js';
import { Plus, Download, Trash2, Check, RefreshCw, AlertCircle, LogOut, Eye, EyeOff, Copy, UserPlus, Search, Users, Phone, Mail, X, Edit2, TrendingUp, DollarSign, Target, UserCheck, FileText, Menu, Key, CheckSquare, Square } from 'lucide-react';

const supabase = createClient(
  'https://wqtylxrrerhbxagdzftn.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxdHlseHJyZXJoYnhhZ2R6ZnRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjkyNjAsImV4cCI6MjA4NzI0NTI2MH0.oXUs9ITNi6lEFat_5FH0x-Exw5MDgRhwx6T0yL3xiWQ'
);

const RESEND_API_KEY = 're_jCpLJKfw_MfWu2jbSzPPgz6pLHQXMAXJb';
const EMAIL_FROM = 'onboarding@resend.dev';

const zones = ['Palm Jumeirah', 'Dubai Marina', 'Downtown', 'Dubai Creek', 'JBR', 'Business Bay', 'JLT', 'DIFC', 'MBR City', 'Dubai Hills', 'Altro'];
const developers = ['Emaar', 'Damac', 'Sobha', 'Meraas', 'Nakheel', 'Dubai Properties', 'Azizi', 'Danube', 'Binghatti', 'Altro'];
const commissions = [2, 4, 5, 6];
const pipelineStati = ['lead', 'trattativa', 'prenotato', 'venduto', 'incassato'];
const pipelineColors = { lead: 'bg-slate-500', trattativa: 'bg-blue-500', prenotato: 'bg-amber-500', venduto: 'bg-emerald-500', incassato: 'bg-green-600' };
const pipelineLabels = { lead: 'üéØ Lead', trattativa: 'üí¨ Trattativa', prenotato: 'üìù Prenotato', venduto: '‚úÖ Venduto', incassato: 'üí∞ Incassato' };
const clienteStati = ['nuovo', 'contattato', 'interessato', 'trattativa', 'acquistato', 'perso'];

const getBaseUrl = () => typeof window !== 'undefined' ? window.location.origin : '';
const fmt = (n) => (n || 0).toLocaleString('en-AE', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

const sendEmail = async (to, subject, html) => {
  try {
    const response = await fetch('https://api.resend.com/emails', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${RESEND_API_KEY}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ from: EMAIL_FROM, to: [to], subject, html }),
    });
    return await response.json();
  } catch (error) { console.error('Email error:', error); return null; }
};

const Logo = ({ size = 'large' }) => (
  <div className={`flex items-center ${size === 'small' ? 'h-10' : 'h-16'}`}>
    <img src="/logo.png" alt="KeyPrime" className={size === 'large' ? 'h-16' : 'h-10'} style={{ objectFit: 'contain' }} />
  </div>
);

const InstallPrompt = ({ onClose }) => {
  const [deferredPrompt, setDeferredPrompt] = useState(null);
  useEffect(() => {
    const handler = (e) => { e.preventDefault(); setDeferredPrompt(e); };
    window.addEventListener('beforeinstallprompt', handler);
    return () => window.removeEventListener('beforeinstallprompt', handler);
  }, []);
  const handleInstall = async () => { if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; setDeferredPrompt(null); onClose(); } };
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  if (!deferredPrompt && isIOS) {
    return (
      <div className="fixed bottom-0 left-0 right-0 bg-slate-800 border-t border-slate-700 p-4 z-50">
        <div className="flex items-start gap-3">
          <div className="w-12 h-12 bg-slate-700 rounded-xl flex items-center justify-center"><img src="/icon-192.png" alt="" className="w-8 h-8 rounded" /></div>
          <div className="flex-1"><div className="text-white font-medium">Installa KeyPrime</div><div className="text-slate-400 text-sm">Tocca <span className="text-blue-400">Condividi</span> poi <span className="text-blue-400">"Aggiungi a Home"</span></div></div>
          <button onClick={onClose} className="text-slate-400"><X className="w-5 h-5" /></button>
        </div>
      </div>
    );
  }
  if (!deferredPrompt) return null;
  return (
    <div className="fixed bottom-0 left-0 right-0 bg-slate-800 border-t border-slate-700 p-4 z-50">
      <div className="flex items-center gap-3">
        <div className="w-12 h-12 bg-slate-700 rounded-xl flex items-center justify-center"><img src="/icon-192.png" alt="" className="w-8 h-8 rounded" /></div>
        <div className="flex-1"><div className="text-white font-medium">Installa KeyPrime</div><div className="text-slate-400 text-sm">Aggiungi alla home</div></div>
        <button onClick={handleInstall} className="bg-amber-500 text-slate-900 px-4 py-2 rounded-lg font-medium">Installa</button>
        <button onClick={onClose} className="text-slate-400"><X className="w-5 h-5" /></button>
      </div>
    </div>
  );
};

const MobileMenu = ({ isOpen, onClose, tabs, activeTab, setActiveTab, user, onLogout }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-50">
      <div className="absolute inset-0 bg-black/70" onClick={onClose} />
      <div className="absolute left-0 top-0 bottom-0 w-72 bg-slate-800 border-r border-slate-700 p-4">
        <div className="flex items-center justify-between mb-6"><Logo size="small" /><button onClick={onClose} className="text-slate-400"><X className="w-6 h-6" /></button></div>
        <div className="space-y-2">{tabs.map(tab => (<button key={tab.id} onClick={() => { setActiveTab(tab.id); onClose(); }} className={`w-full text-left px-4 py-3 rounded-xl font-medium ${activeTab === tab.id ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-white'}`}>{tab.icon} {tab.label}</button>))}</div>
        <div className="absolute bottom-4 left-4 right-4">
          <div className="bg-slate-700/50 rounded-xl p-4 mb-4"><div className="text-slate-400 text-sm">{user?.ruolo}</div><div className="text-white font-medium">{user?.nome}</div></div>
          <button onClick={onLogout} className="w-full bg-red-500/20 text-red-400 rounded-xl py-3 flex items-center justify-center gap-2"><LogOut className="w-5 h-5" /> Esci</button>
        </div>
      </div>
    </div>
  );
};

const SelectWithOther = ({ value, onChange, options, placeholder, className }) => {
  const [showCustom, setShowCustom] = useState(false);
  const [customValue, setCustomValue] = useState('');
  useEffect(() => { if (value && !options.includes(value) && value !== 'Altro') { setShowCustom(true); setCustomValue(value); } }, [value, options]);
  const handleChange = (e) => { const val = e.target.value; if (val === 'Altro') { setShowCustom(true); setCustomValue(''); onChange(''); } else { setShowCustom(false); onChange(val); } };
  const handleCustomChange = (e) => { setCustomValue(e.target.value); onChange(e.target.value); };
  return (<div className="space-y-2"><select value={showCustom ? 'Altro' : value} onChange={handleChange} className={className}><option value="">{placeholder || 'Seleziona'}</option>{options.map(opt => <option key={opt} value={opt}>{opt}</option>)}</select>{showCustom && (<input type="text" value={customValue} onChange={handleCustomChange} placeholder="Specifica..." className={className} autoFocus />)}</div>);
};

export default function App() {
  const [view, setView] = useState('login');
  const [user, setUser] = useState(null);
  const [sales, setSales] = useState([]);
  const [users, setUsers] = useState([]);
  const [clienti, setClienti] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [showForm, setShowForm] = useState(null);
  const [saveStatus, setSaveStatus] = useState('');
  const [showUserModal, setShowUserModal] = useState(false);
  const [showClienteModal, setShowClienteModal] = useState(false);
  const [editingCliente, setEditingCliente] = useState(null);
  const [editingUser, setEditingUser] = useState(null);
  const [adminTab, setAdminTab] = useState('dashboard');
  const [filters, setFilters] = useState({ search: '', stato: '', agente: '', zona: '', pagato: '' });
  const [convertingSale, setConvertingSale] = useState(null);
  const [agentTab, setAgentTab] = useState('lista');
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [selectedSales, setSelectedSales] = useState([]);
  const [showInstallPrompt, setShowInstallPrompt] = useState(true);
  const [showPasswordModal, setShowPasswordModal] = useState(false);

  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const role = params.get('role'); const username = params.get('user');
    if (role && username) verifyDirectAccess(username, role);
    else { const saved = localStorage.getItem('keyprime_user'); if (saved) { const p = JSON.parse(saved); setUser(p); setView(p.ruolo === 'admin' ? 'admin' : p.ruolo); } }
    if (localStorage.getItem('pwa_prompt_dismissed')) setShowInstallPrompt(false);
  }, []);

  const dismissInstallPrompt = () => { setShowInstallPrompt(false); localStorage.setItem('pwa_prompt_dismissed', 'true'); };
  const verifyDirectAccess = async (username, role) => { const { data } = await supabase.from('user_credentials').select('*').eq('username', username).eq('ruolo', role).eq('attivo', true).single(); if (data) { setUser(data); localStorage.setItem('keyprime_user', JSON.stringify(data)); setView(role === 'admin' ? 'admin' : role); } };
  const loadSales = async () => { setLoading(true); const { data } = await supabase.from('sales_with_commissions').select('*').order('created_at', { ascending: false }); setSales(data || []); setLoading(false); };
  const loadUsers = async () => { const { data } = await supabase.from('user_credentials').select('*').order('created_at', { ascending: false }); setUsers(data || []); };
  const loadClienti = async () => { const { data } = await supabase.from('clienti').select('*').order('created_at', { ascending: false }); setClienti(data || []); };
  useEffect(() => { if (user) { loadSales(); if (user.ruolo === 'admin') { loadUsers(); loadClienti(); } } }, [user]);
  const handleLogin = async (username, password) => { setLoading(true); setError(null); const { data, error: err } = await supabase.from('user_credentials').select('*').eq('username', username).eq('password', password).eq('attivo', true).single(); if (err || !data) { setError('Credenziali non valide'); setLoading(false); return; } setUser(data); localStorage.setItem('keyprime_user', JSON.stringify(data)); setView(data.ruolo === 'admin' ? 'admin' : data.ruolo); setLoading(false); };
  const handleLogout = () => { setUser(null); localStorage.removeItem('keyprime_user'); setView('login'); window.history.replaceState({}, document.title, window.location.pathname); setMobileMenuOpen(false); };
  const changePassword = async (newPassword) => { const { error } = await supabase.from('user_credentials').update({ password: newPassword }).eq('id', user.id); if (error) { setError(error.message); return false; } const updated = { ...user, password: newPassword }; setUser(updated); localStorage.setItem('keyprime_user', JSON.stringify(updated)); setShowPasswordModal(false); setSaveStatus('Password aggiornata!'); setTimeout(() => setSaveStatus(''), 2000); return true; };

  const addLead = async (leadData) => {
    setSaveStatus('Salvataggio...');
    let cliente_id = null;
    if (leadData.cliente_nome) {
      const { data: clienteData } = await supabase.from('clienti').insert([{ nome: leadData.cliente_nome, cognome: leadData.cliente_cognome, email: leadData.cliente_email, telefono: leadData.cliente_telefono, whatsapp: leadData.cliente_whatsapp, nazionalita: leadData.cliente_nazionalita, budget_min: leadData.cliente_budget_min ? parseFloat(leadData.cliente_budget_min) : null, budget_max: leadData.cliente_budget_max ? parseFloat(leadData.cliente_budget_max) : null, note: leadData.cliente_note, stato: 'nuovo', fonte: 'Agente', agente_riferimento: user?.nome, created_by: user?.nome, referente: user?.referente }]).select().single();
      if (clienteData) cliente_id = clienteData.id;
    }
    const { error: err } = await supabase.from('sales').insert([{ data: leadData.data, developer: leadData.developer, progetto: leadData.progetto, zona: leadData.zona, valore: leadData.valore || 0, agente: leadData.agente, segnalatore: leadData.segnalatore, referente: user?.referente, commission_pct: 5, inserted_by: user?.nome, inserted_as: user?.ruolo, pagato: false, stato: leadData.stato || 'lead', cliente_id }]);
    if (err) { setSaveStatus('Errore!'); setError(err.message); } else { setSaveStatus('Lead salvato!'); setShowForm(null); loadSales(); setTimeout(() => setSaveStatus(''), 2000); }
  };

  const addSale = async (saleData) => { setSaveStatus('Salvataggio...'); const { error: err } = await supabase.from('sales').insert([{ ...saleData, referente: user?.referente, commission_pct: 5, inserted_by: user?.nome, inserted_as: user?.ruolo, pagato: false, stato: 'venduto' }]); if (err) { setSaveStatus('Errore!'); setError(err.message); } else { setSaveStatus('Vendita registrata!'); setShowForm(null); loadSales(); setTimeout(() => setSaveStatus(''), 2000); } };
  const convertLeadToSale = async (saleId, valore) => { setSaveStatus('Conversione...'); const { error: err } = await supabase.from('sales').update({ stato: 'venduto', valore }).eq('id', saleId); if (err) { setSaveStatus('Errore!'); } else { setSaveStatus('Convertito!'); setConvertingSale(null); loadSales(); setTimeout(() => setSaveStatus(''), 2000); } };
  const updateSale = async (id, updates) => { const sale = sales.find(s => s.id === id); if (updates.pagato === true && !sale?.pagato) { const targetName = sale.agente || sale.segnalatore; if (targetName) { const { data: targetUser } = await supabase.from('user_credentials').select('*').eq('nome', targetName).single(); if (targetUser?.email) { const commRate = sale.agente ? 0.7 : 0.3; const commAmount = Number(sale.valore) * (sale.commission_pct || 5) / 100 * commRate; await sendEmail(targetUser.email, 'üí∞ Commissione Pagata - KeyPrime', `<div style="font-family:Arial;"><h2>Commissione Pagata!</h2><p>Progetto: ${sale.progetto}</p><p>Commissione: ${fmt(commAmount)} AED</p></div>`); } } } await supabase.from('sales').update(updates).eq('id', id); loadSales(); };
  const deleteSale = async (id) => { if (!window.confirm('Eliminare?')) return; await supabase.from('sales').delete().eq('id', id); loadSales(); };
  const deleteSelectedSales = async () => { if (selectedSales.length === 0) return; if (!window.confirm(`Eliminare ${selectedSales.length} elementi?`)) return; for (const id of selectedSales) { await supabase.from('sales').delete().eq('id', id); } setSelectedSales([]); loadSales(); setSaveStatus(`${selectedSales.length} eliminati`); setTimeout(() => setSaveStatus(''), 2000); };
  const toggleSelectSale = (id) => { setSelectedSales(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]); };
  const selectAllSales = () => { if (selectedSales.length === filteredSales.length) setSelectedSales([]); else setSelectedSales(filteredSales.map(s => s.id)); };
  const createUser = async (userData) => { const { error: err } = await supabase.from('user_credentials').insert([userData]); if (err) { setError(err.message); return false; } loadUsers(); setShowUserModal(false); return true; };
  const updateUser = async (id, userData) => { const { error: err } = await supabase.from('user_credentials').update(userData).eq('id', id); if (err) { setError(err.message); return false; } loadUsers(); setShowUserModal(false); setEditingUser(null); return true; };
  const deleteUser = async (id) => { if (!window.confirm('Eliminare utente?')) return; await supabase.from('user_credentials').delete().eq('id', id); loadUsers(); };
  const createCliente = async (data) => { const { error: err } = await supabase.from('clienti').insert([{ ...data, created_by: user?.nome, referente: user?.referente }]); if (err) { setError(err.message); return false; } loadClienti(); setShowClienteModal(false); return true; };
  const updateCliente = async (id, data) => { const { error: err } = await supabase.from('clienti').update(data).eq('id', id); if (err) { setError(err.message); return false; } loadClienti(); setShowClienteModal(false); return true; };
  const deleteCliente = async (id) => { if (!window.confirm('Eliminare?')) return; await supabase.from('clienti').delete().eq('id', id); loadClienti(); };
  const exportToCSV = () => { let csv = '\ufeffData,Developer,Agente,Segnalatore,Progetto,Zona,Valore,Stato,Pagato\n'; filteredSales.forEach(s => { csv += `${s.data},"${s.developer}","${s.agente||''}","${s.segnalatore||''}","${s.progetto}","${s.zona}",${s.valore},${s.stato||'lead'},${s.pagato?'SI':'NO'}\n`; }); const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); link.download = `KeyPrime_${new Date().toISOString().split('T')[0]}.csv`; link.click(); };
  const filteredSales = sales.filter(s => { if (filters.search && !`${s.progetto} ${s.developer} ${s.agente} ${s.segnalatore}`.toLowerCase().includes(filters.search.toLowerCase())) return false; if (filters.stato && s.stato !== filters.stato) return false; if (filters.agente && s.agente !== filters.agente) return false; if (filters.pagato === 'si' && !s.pagato) return false; if (filters.pagato === 'no' && s.pagato) return false; return true; });
  const ErrorBanner = () => error && (<div className="bg-red-500/20 border border-red-500/50 text-red-300 rounded-xl px-4 py-3 mb-4 flex items-center gap-2"><AlertCircle className="w-5 h-5" /><span className="text-sm">{error}</span><button onClick={() => setError(null)} className="ml-auto">‚úï</button></div>);

  if (view === 'login') return <LoginPage onLogin={handleLogin} loading={loading} error={error} setError={setError} />;

  // AGENTE / SEGNALATORE
  if (view === 'agente' || view === 'segnalatore') {
    const type = view;
    const mySales = sales.filter(s => type === 'agente' ? s.agente === user?.nome : s.segnalatore === user?.nome);
    const rate = type === 'agente' ? 0.7 : 0.3;
    const myVendite = mySales.filter(s => s.stato === 'venduto' || s.stato === 'incassato');
    const totalComm = myVendite.reduce((sum, s) => sum + (Number(s.valore) * (s.commission_pct || 5) / 100 * rate), 0);
    const pagate = myVendite.filter(s => s.pagato).reduce((sum, s) => sum + (Number(s.valore) * (s.commission_pct || 5) / 100 * rate), 0);
    const byStato = pipelineStati.reduce((acc, stato) => { acc[stato] = mySales.filter(s => (s.stato || 'lead') === stato); return acc; }, {});
    const agentTabs = [{ id: 'lista', icon: 'üìã', label: 'Lista' }, { id: 'pipeline', icon: 'üéØ', label: 'Pipeline' }, { id: 'settings', icon: '‚öôÔ∏è', label: 'Impostazioni' }];

    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4">
        <div className="max-w-4xl mx-auto">
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center gap-3"><button onClick={() => setMobileMenuOpen(true)} className="md:hidden text-slate-400"><Menu className="w-6 h-6" /></button><Logo size="small" /></div>
            <div className="hidden md:flex items-center gap-4"><div className="text-right"><div className="text-slate-400 text-sm">{type === 'agente' ? 'Agente' : 'Segnalatore'}</div><div className="text-white font-medium">{user?.nome}</div></div><button onClick={() => setShowPasswordModal(true)} className="text-slate-400 hover:text-white"><Key className="w-5 h-5" /></button><button onClick={handleLogout} className="text-slate-400 hover:text-white"><LogOut className="w-5 h-5" /></button></div>
          </div>
          <MobileMenu isOpen={mobileMenuOpen} onClose={() => setMobileMenuOpen(false)} tabs={agentTabs} activeTab={agentTab} setActiveTab={setAgentTab} user={user} onLogout={handleLogout} />
          <ErrorBanner />
          {saveStatus && <div className="bg-emerald-500/20 border border-emerald-500/50 text-emerald-300 rounded-xl px-4 py-2 mb-4 text-center">{saveStatus}</div>}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <div className="bg-slate-800 border border-slate-700 rounded-2xl p-3"><div className="text-slate-400 text-xs">Lead</div><div className="text-2xl font-bold text-white">{mySales.length}</div></div>
            <div className="bg-slate-800 border border-slate-700 rounded-2xl p-3"><div className="text-slate-400 text-xs">Vendite</div><div className="text-2xl font-bold text-emerald-400">{myVendite.length}</div></div>
            <div className="bg-emerald-900/30 border border-emerald-700/50 rounded-2xl p-3"><div className="text-emerald-300 text-xs">‚úì Pagate</div><div className="text-lg font-bold text-emerald-400">{fmt(pagate)}</div></div>
            <div className="bg-red-900/30 border border-red-700/50 rounded-2xl p-3"><div className="text-red-300 text-xs">‚è≥ Pending</div><div className="text-lg font-bold text-red-400">{fmt(totalComm - pagate)}</div></div>
          </div>
          {!showForm && !convertingSale && agentTab !== 'settings' && (<div className="grid grid-cols-2 gap-3 mb-6"><button onClick={() => setShowForm('lead')} className="bg-blue-500 hover:bg-blue-600 text-white rounded-xl p-3 flex items-center justify-center gap-2 font-semibold text-sm"><Target className="w-4 h-4" /> Nuovo Lead</button><button onClick={() => setShowForm('vendita')} className="bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl p-3 flex items-center justify-center gap-2 font-semibold text-sm"><DollarSign className="w-4 h-4" /> Vendita Diretta</button></div>)}
          {showForm === 'lead' && <LeadForm type={type} userName={user?.nome} onSubmit={addLead} onCancel={() => setShowForm(null)} />}
          {showForm === 'vendita' && <SaleForm type={type} userName={user?.nome} onSubmit={addSale} onCancel={() => setShowForm(null)} />}
          {convertingSale && <ConvertLeadModal sale={convertingSale} onConvert={convertLeadToSale} onCancel={() => setConvertingSale(null)} />}
          <div className="hidden md:flex gap-2 mb-4">{agentTabs.map(tab => (<button key={tab.id} onClick={() => setAgentTab(tab.id)} className={`px-4 py-2 rounded-xl font-medium ${agentTab === tab.id ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-white'}`}>{tab.icon} {tab.label}</button>))}<div className="flex-1" /><button onClick={loadSales} className="bg-slate-700 text-white rounded-xl px-3 py-2"><RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} /></button></div>
          {agentTab === 'lista' && (mySales.length === 0 ? (<div className="bg-slate-800/50 border border-slate-700 rounded-xl p-8 text-center text-slate-500">Nessun lead</div>) : (<div className="space-y-3">{mySales.map(sale => { const myComm = (sale.stato === 'venduto' || sale.stato === 'incassato') ? Number(sale.valore) * (sale.commission_pct || 5) / 100 * rate : 0; const showConvertButton = ['prenotato', 'trattativa'].includes(sale.stato) || (sale.stato === 'venduto' && sale.valore === 0); return (<div key={sale.id} className="bg-slate-800 border border-slate-700 rounded-xl p-4"><div className="flex justify-between items-start mb-2"><div><div className="flex items-center gap-2 flex-wrap"><span className="text-white font-medium">{sale.progetto || 'Da definire'}</span><span className={`px-2 py-0.5 rounded text-xs text-white ${pipelineColors[sale.stato || 'lead']}`}>{pipelineLabels[sale.stato || 'lead']}</span></div><div className="text-slate-400 text-sm">{sale.developer} ‚Ä¢ {sale.zona}</div>{sale.cliente_nome && <div className="text-blue-400 text-xs mt-1">üë§ {sale.cliente_nome}</div>}</div><div className="text-right">{sale.valore > 0 ? <div className="text-amber-400 font-semibold">{fmt(sale.valore)} AED</div> : <div className="text-slate-500 text-sm">TBD</div>}<div className="text-slate-500 text-xs">{new Date(sale.data).toLocaleDateString('it-IT')}</div></div></div><div className="flex items-center gap-2 py-2 border-t border-b border-slate-700 my-2 overflow-x-auto"><span className="text-slate-400 text-xs">Stato:</span>{pipelineStati.slice(0, -1).map(stato => (<button key={stato} onClick={() => updateSale(sale.id, { stato })} className={`px-2 py-1 rounded text-xs whitespace-nowrap ${sale.stato === stato ? `${pipelineColors[stato]} text-white` : 'bg-slate-700 text-slate-400'}`}>{stato}</button>))}</div><div className="flex justify-between items-center"><div className="text-sm">{myComm > 0 ? (<><span className="text-slate-400">Comm: </span><span className="text-amber-300 font-medium">{fmt(myComm)}</span><span className={`ml-2 px-2 py-0.5 rounded text-xs ${sale.pagato ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>{sale.pagato ? '‚úì' : '‚è≥'}</span></>) : <span className="text-slate-500 text-xs">-</span>}</div>{showConvertButton && <button onClick={() => setConvertingSale(sale)} className="bg-emerald-500 text-white px-3 py-1 rounded-lg text-xs">üí∞ Registra</button>}</div></div>); })}</div>))}
          {agentTab === 'pipeline' && (<div className="grid grid-cols-2 md:grid-cols-4 gap-2">{pipelineStati.slice(0, -1).map(stato => (<div key={stato} className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden"><div className={`${pipelineColors[stato]} px-3 py-2 text-white font-semibold text-xs flex justify-between`}><span>{stato}</span><span className="bg-white/20 px-1.5 rounded">{byStato[stato]?.length || 0}</span></div><div className="p-2 space-y-2 max-h-[50vh] overflow-y-auto">{byStato[stato]?.map(sale => (<div key={sale.id} className="bg-slate-700/50 rounded-lg p-2"><div className="text-white text-xs font-medium truncate">{sale.progetto || 'TBD'}</div>{sale.cliente_nome && <div className="text-blue-400 text-xs">üë§ {sale.cliente_nome}</div>}{sale.valore > 0 && <div className="text-amber-400 text-xs mt-1">{fmt(sale.valore)}</div>}</div>))}{(!byStato[stato] || byStato[stato].length === 0) && <div className="text-slate-500 text-xs text-center py-4">-</div>}</div></div>))}</div>)}
          {agentTab === 'settings' && (<div className="bg-slate-800 border border-slate-700 rounded-xl p-6"><h3 className="text-white font-semibold mb-4">Impostazioni Account</h3><div className="space-y-4"><div className="flex justify-between items-center py-3 border-b border-slate-700"><div><div className="text-white">Email</div><div className="text-slate-400 text-sm">{user?.email || 'Non impostata'}</div></div></div><div className="flex justify-between items-center py-3"><div><div className="text-white">Password</div><div className="text-slate-400 text-sm">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div></div><button onClick={() => setShowPasswordModal(true)} className="bg-amber-500 text-slate-900 px-4 py-2 rounded-lg text-sm font-medium">Cambia</button></div></div></div>)}
        </div>
        {showInstallPrompt && <InstallPrompt onClose={dismissInstallPrompt} />}
        {showPasswordModal && <PasswordModal currentPassword={user?.password} onSave={changePassword} onClose={() => setShowPasswordModal(false)} />}
      </div>
    );
  }

  // ADMIN
  if (view === 'admin') {
    const totals = sales.reduce((acc, s) => { const comm = Number(s.valore) * (s.commission_pct || 5) / 100; const ag = s.agente ? comm * 0.7 : 0; const sg = s.segnalatore ? comm * 0.3 : 0; const netto = comm - ag - sg; const pell = s.referente === 'Pellegrino' ? netto * 0.7 : (s.referente === 'Giovanni' ? netto * 0.3 : 0); const giov = s.referente === 'Giovanni' ? netto * 0.7 : (s.referente === 'Pellegrino' ? netto * 0.3 : 0); return { valore: acc.valore + Number(s.valore), comm: acc.comm + comm, ag: acc.ag + ag, sg: acc.sg + sg, netto: acc.netto + netto, pell: acc.pell + pell, giov: acc.giov + giov }; }, { valore: 0, comm: 0, ag: 0, sg: 0, netto: 0, pell: 0, giov: 0 });
    const byStato = pipelineStati.reduce((acc, stato) => { acc[stato] = sales.filter(s => (s.stato || 'lead') === stato); return acc; }, {});
    const byMonth = sales.reduce((acc, s) => { const month = s.data?.substring(0, 7) || 'N/A'; acc[month] = (acc[month] || 0) + Number(s.valore); return acc; }, {});
    const byAgente = sales.reduce((acc, s) => { if (s.agente) acc[s.agente] = (acc[s.agente] || 0) + Number(s.valore); return acc; }, {});
    const uniqueAgenti = [...new Set(sales.map(s => s.agente).filter(Boolean))];
    const adminTabs = [{ id: 'dashboard', icon: 'üìä', label: 'Dashboard' }, { id: 'vendite', icon: 'üí∞', label: 'Vendite' }, { id: 'pipeline', icon: 'üéØ', label: 'Pipeline' }, { id: 'clienti', icon: 'üë•', label: 'CRM' }, { id: 'utenti', icon: '‚öôÔ∏è', label: 'Utenti' }];

    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4">
        <div className="max-w-7xl mx-auto">
          <div className="flex items-center justify-between mb-6"><div className="flex items-center gap-3"><button onClick={() => setMobileMenuOpen(true)} className="md:hidden text-slate-400"><Menu className="w-6 h-6" /></button><Logo size="small" /></div><div className="hidden md:flex items-center gap-4"><div className="text-right"><div className="text-slate-400 text-sm">Admin</div><div className="text-white font-medium">{user?.nome}</div></div><button onClick={handleLogout} className="text-slate-400 hover:text-white"><LogOut className="w-5 h-5" /></button></div></div>
          <MobileMenu isOpen={mobileMenuOpen} onClose={() => setMobileMenuOpen(false)} tabs={adminTabs} activeTab={adminTab} setActiveTab={setAdminTab} user={user} onLogout={handleLogout} />
          <ErrorBanner />
          {saveStatus && <div className="bg-emerald-500/20 border border-emerald-500/50 text-emerald-300 rounded-xl px-4 py-2 mb-4 text-center">{saveStatus}</div>}
          <div className="hidden md:flex gap-2 mb-6 overflow-x-auto pb-2">{adminTabs.map(tab => (<button key={tab.id} onClick={() => setAdminTab(tab.id)} className={`px-4 py-2 rounded-xl font-medium whitespace-nowrap ${adminTab === tab.id ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-white'}`}>{tab.icon} {tab.label}</button>))}</div>
          {adminTab === 'dashboard' && <DashboardTab totals={totals} sales={sales} byStato={byStato} byMonth={byMonth} byAgente={byAgente} fmt={fmt} pipelineColors={pipelineColors} />}
          {adminTab === 'vendite' && <VenditeTab sales={filteredSales} allSales={sales} loading={loading} filters={filters} setFilters={setFilters} uniqueAgenti={uniqueAgenti} updateSale={updateSale} deleteSale={deleteSale} loadSales={loadSales} exportToCSV={exportToCSV} totals={totals} fmt={fmt} selectedSales={selectedSales} toggleSelectSale={toggleSelectSale} selectAllSales={selectAllSales} deleteSelectedSales={deleteSelectedSales} />}
          {adminTab === 'pipeline' && <PipelineTab sales={sales} byStato={byStato} updateSale={updateSale} fmt={fmt} pipelineColors={pipelineColors} pipelineLabels={pipelineLabels} />}
          {adminTab === 'clienti' && <ClientiTab clienti={clienti} loadClienti={loadClienti} createCliente={createCliente} updateCliente={updateCliente} deleteCliente={deleteCliente} showModal={showClienteModal} setShowModal={setShowClienteModal} editingCliente={editingCliente} setEditingCliente={setEditingCliente} sales={sales} />}
          {adminTab === 'utenti' && <UserManagement users={users} loadUsers={loadUsers} createUser={createUser} updateUser={updateUser} deleteUser={deleteUser} showUserModal={showUserModal} setShowUserModal={setShowUserModal} editingUser={editingUser} setEditingUser={setEditingUser} />}
        </div>
        {showInstallPrompt && <InstallPrompt onClose={dismissInstallPrompt} />}
      </div>
    );
  }
  return null;
}

function PasswordModal({ currentPassword, onSave, onClose }) {
  const [oldPw, setOldPw] = useState(''); const [newPw, setNewPw] = useState(''); const [confirmPw, setConfirmPw] = useState(''); const [error, setError] = useState('');
  const handleSave = () => { if (oldPw !== currentPassword) { setError('Password attuale errata'); return; } if (newPw.length < 6) { setError('Min 6 caratteri'); return; } if (newPw !== confirmPw) { setError('Password non coincidono'); return; } onSave(newPw); };
  const inp = "w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white";
  return (<div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50"><div className="bg-slate-800 rounded-2xl p-6 max-w-sm w-full border border-slate-700"><h3 className="text-xl font-semibold text-white mb-4">Cambia Password</h3>{error && <div className="bg-red-500/20 text-red-300 rounded-lg px-3 py-2 mb-4 text-sm">{error}</div>}<div className="space-y-4"><div><label className="block text-slate-300 text-sm mb-2">Password attuale</label><input type="password" value={oldPw} onChange={(e) => setOldPw(e.target.value)} className={inp} /></div><div><label className="block text-slate-300 text-sm mb-2">Nuova password</label><input type="password" value={newPw} onChange={(e) => setNewPw(e.target.value)} className={inp} /></div><div><label className="block text-slate-300 text-sm mb-2">Conferma</label><input type="password" value={confirmPw} onChange={(e) => setConfirmPw(e.target.value)} className={inp} /></div><div className="flex gap-3 pt-4"><button onClick={onClose} className="flex-1 bg-slate-700 text-white rounded-xl py-3">Annulla</button><button onClick={handleSave} className="flex-1 bg-amber-500 text-slate-900 rounded-xl py-3 font-semibold">Salva</button></div></div></div></div>);
}

function LeadForm({ type, userName, onSubmit, onCancel }) {
  const [form, setForm] = useState({ data: new Date().toISOString().split('T')[0], developer: '', progetto: '', zona: '', valore: '', altroNome: '', stato: 'lead', cliente_nome: '', cliente_cognome: '', cliente_email: '', cliente_telefono: '', cliente_whatsapp: '', cliente_nazionalita: '', cliente_budget_min: '', cliente_budget_max: '', cliente_note: '' });
  const handleSubmit = () => { if (!form.cliente_nome) { alert('Nome cliente obbligatorio'); return; } onSubmit({ data: form.data, developer: form.developer || 'Da definire', progetto: form.progetto || 'Da definire', zona: form.zona || 'Da definire', valore: form.valore ? parseFloat(form.valore) : 0, agente: type === 'agente' ? userName : (form.altroNome || null), segnalatore: type === 'segnalatore' ? userName : (form.altroNome || null), stato: form.stato, cliente_nome: form.cliente_nome, cliente_cognome: form.cliente_cognome, cliente_email: form.cliente_email, cliente_telefono: form.cliente_telefono, cliente_whatsapp: form.cliente_whatsapp, cliente_nazionalita: form.cliente_nazionalita, cliente_budget_min: form.cliente_budget_min, cliente_budget_max: form.cliente_budget_max, cliente_note: form.cliente_note }); };
  const inp = "w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white text-sm";
  return (<div className="bg-blue-900/20 border border-blue-500/30 rounded-2xl p-4 mb-6 max-h-[80vh] overflow-y-auto"><h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2"><Target className="w-5 h-5 text-blue-400" /> Nuovo Lead</h3><div className="bg-slate-800/50 rounded-xl p-3 mb-4"><h4 className="text-white text-sm font-medium mb-2">üë§ Cliente</h4><div className="grid grid-cols-2 gap-2"><input type="text" placeholder="Nome *" value={form.cliente_nome} onChange={(e) => setForm({ ...form, cliente_nome: e.target.value })} className={inp} /><input type="text" placeholder="Cognome" value={form.cliente_cognome} onChange={(e) => setForm({ ...form, cliente_cognome: e.target.value })} className={inp} /><input type="email" placeholder="Email" value={form.cliente_email} onChange={(e) => setForm({ ...form, cliente_email: e.target.value })} className={inp} /><input type="tel" placeholder="Telefono" value={form.cliente_telefono} onChange={(e) => setForm({ ...form, cliente_telefono: e.target.value })} className={inp} /><input type="tel" placeholder="WhatsApp" value={form.cliente_whatsapp} onChange={(e) => setForm({ ...form, cliente_whatsapp: e.target.value })} className={inp} /><input type="text" placeholder="Nazionalit√†" value={form.cliente_nazionalita} onChange={(e) => setForm({ ...form, cliente_nazionalita: e.target.value })} className={inp} /><input type="number" placeholder="Budget Min" value={form.cliente_budget_min} onChange={(e) => setForm({ ...form, cliente_budget_min: e.target.value })} className={inp} /><input type="number" placeholder="Budget Max" value={form.cliente_budget_max} onChange={(e) => setForm({ ...form, cliente_budget_max: e.target.value })} className={inp} /></div><textarea placeholder="Note..." value={form.cliente_note} onChange={(e) => setForm({ ...form, cliente_note: e.target.value })} className={`${inp} mt-2 h-16`} /></div><div className="bg-slate-800/50 rounded-xl p-3 mb-4"><h4 className="text-white text-sm font-medium mb-2">üè† Interesse</h4><div className="grid grid-cols-2 gap-2"><SelectWithOther value={form.developer} onChange={(v) => setForm({ ...form, developer: v })} options={developers} placeholder="Developer" className={inp} /><SelectWithOther value={form.zona} onChange={(v) => setForm({ ...form, zona: v })} options={zones} placeholder="Zona" className={inp} /><input type="text" placeholder="Progetto" value={form.progetto} onChange={(e) => setForm({ ...form, progetto: e.target.value })} className={inp} /><input type="number" placeholder="Valore stimato" value={form.valore} onChange={(e) => setForm({ ...form, valore: e.target.value })} className={inp} /></div></div><div className="bg-slate-800/50 rounded-xl p-3 mb-4"><h4 className="text-white text-sm font-medium mb-2">Pipeline</h4><div className="flex flex-wrap gap-2">{pipelineStati.slice(0, 4).map(stato => (<button key={stato} type="button" onClick={() => setForm({ ...form, stato })} className={`px-3 py-1.5 rounded-lg text-xs font-medium ${form.stato === stato ? `${pipelineColors[stato]} text-white` : 'bg-slate-700 text-slate-400'}`}>{pipelineLabels[stato]}</button>))}</div></div><div className="flex gap-3"><button onClick={onCancel} className="flex-1 bg-slate-700 text-white rounded-xl py-3 text-sm">Annulla</button><button onClick={handleSubmit} className="flex-1 bg-blue-500 text-white rounded-xl py-3 font-semibold text-sm">Salva Lead</button></div></div>);
}

function SaleForm({ type, userName, onSubmit, onCancel }) {
  const [form, setForm] = useState({ data: new Date().toISOString().split('T')[0], developer: '', progetto: '', zona: '', valore: '', altroNome: '' });
  const handleSubmit = () => { if (!form.developer || !form.progetto || !form.zona || !form.valore) { alert('Compila tutti i campi'); return; } onSubmit({ data: form.data, developer: form.developer, progetto: form.progetto, zona: form.zona, valore: parseFloat(form.valore), agente: type === 'agente' ? userName : (form.altroNome || null), segnalatore: type === 'segnalatore' ? userName : (form.altroNome || null) }); };
  const inp = "w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white text-sm";
  return (<div className="bg-emerald-900/20 border border-emerald-500/30 rounded-2xl p-4 mb-6"><h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2"><DollarSign className="w-5 h-5 text-emerald-400" /> Vendita Diretta</h3><div className="grid grid-cols-2 gap-3"><div><label className="text-slate-400 text-xs">Data</label><input type="date" value={form.data} onChange={(e) => setForm({ ...form, data: e.target.value })} className={inp} /></div><div><label className="text-slate-400 text-xs">Developer *</label><SelectWithOther value={form.developer} onChange={(v) => setForm({ ...form, developer: v })} options={developers} className={inp} /></div><div><label className="text-slate-400 text-xs">Progetto *</label><input type="text" value={form.progetto} onChange={(e) => setForm({ ...form, progetto: e.target.value })} className={inp} /></div><div><label className="text-slate-400 text-xs">Zona *</label><SelectWithOther value={form.zona} onChange={(v) => setForm({ ...form, zona: v })} options={zones} className={inp} /></div><div><label className="text-slate-400 text-xs">Valore (AED) *</label><input type="number" value={form.valore} onChange={(e) => setForm({ ...form, valore: e.target.value })} className={inp} /></div><div><label className="text-slate-400 text-xs">{type === 'agente' ? 'Segnalatore' : 'Agente'}</label><input type="text" value={form.altroNome} onChange={(e) => setForm({ ...form, altroNome: e.target.value })} className={inp} /></div></div><div className="flex gap-3 mt-4"><button onClick={onCancel} className="flex-1 bg-slate-700 text-white rounded-xl py-3 text-sm">Annulla</button><button onClick={handleSubmit} className="flex-1 bg-emerald-500 text-white rounded-xl py-3 font-semibold text-sm">Registra</button></div></div>);
}

function ConvertLeadModal({ sale, onConvert, onCancel }) {
  const [valore, setValore] = useState(sale.valore || '');
  return (<div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50"><div className="bg-slate-800 rounded-2xl p-6 max-w-md w-full border border-slate-700"><h3 className="text-xl font-semibold text-white mb-4">üéâ Registra Vendita</h3><div className="bg-slate-700/50 rounded-xl p-4 mb-4"><div className="text-white font-medium">{sale.progetto}</div><div className="text-slate-400 text-sm">{sale.developer} ‚Ä¢ {sale.zona}</div></div><div className="mb-4"><label className="block text-slate-300 text-sm mb-2">Valore (AED) *</label><input type="number" value={valore} onChange={(e) => setValore(e.target.value)} className="w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white text-lg" autoFocus /></div><div className="flex gap-3"><button onClick={onCancel} className="flex-1 bg-slate-700 text-white rounded-xl py-3">Annulla</button><button onClick={() => valore && onConvert(sale.id, parseFloat(valore))} disabled={!valore} className="flex-1 bg-emerald-500 disabled:bg-slate-600 text-white rounded-xl py-3 font-semibold">Conferma</button></div></div></div>);
}

function DashboardTab({ totals, sales, byStato, byMonth, byAgente, fmt, pipelineColors }) {
  const sortedMonths = Object.entries(byMonth).sort((a, b) => a[0].localeCompare(b[0])).slice(-6);
  const maxMonth = Math.max(...sortedMonths.map(([, v]) => v)) || 1;
  const sortedAgenti = Object.entries(byAgente).sort((a, b) => b[1] - a[1]).slice(0, 5);
  const maxAgente = sortedAgenti[0]?.[1] || 1;
  return (<div className="space-y-6"><div className="grid grid-cols-2 md:grid-cols-4 gap-3"><div className="bg-blue-500/20 border border-blue-500/30 rounded-xl p-4"><div className="text-blue-300 text-xs flex items-center gap-1"><Target className="w-3 h-3" />Lead</div><div className="text-2xl font-bold text-white">{sales.length}</div></div><div className="bg-amber-500/20 border border-amber-500/30 rounded-xl p-4"><div className="text-amber-300 text-xs flex items-center gap-1"><DollarSign className="w-3 h-3" />Volume</div><div className="text-xl font-bold text-white">{fmt(totals.valore)}</div></div><div className="bg-emerald-500/20 border border-emerald-500/30 rounded-xl p-4"><div className="text-emerald-300 text-xs flex items-center gap-1"><TrendingUp className="w-3 h-3" />Commissioni</div><div className="text-xl font-bold text-white">{fmt(totals.comm)}</div></div><div className="bg-purple-500/20 border border-purple-500/30 rounded-xl p-4"><div className="text-purple-300 text-xs flex items-center gap-1"><UserCheck className="w-3 h-3" />Netto KP</div><div className="text-xl font-bold text-white">{fmt(totals.netto)}</div></div></div><div className="bg-slate-800 border border-slate-700 rounded-xl p-4"><h3 className="text-white font-semibold mb-3">Pipeline</h3><div className="flex gap-2 overflow-x-auto pb-2">{Object.entries(byStato).map(([stato, items]) => (<div key={stato} className="flex-1 min-w-[80px]"><div className={`${pipelineColors[stato]} rounded-lg p-3 text-center text-white`}><div className="text-2xl font-bold">{items.length}</div><div className="text-xs opacity-80 capitalize">{stato}</div></div></div>))}</div></div><div className="grid md:grid-cols-2 gap-4"><div className="bg-slate-800 border border-slate-700 rounded-xl p-4"><h3 className="text-white font-semibold mb-3">Mensile</h3><div className="space-y-2">{sortedMonths.map(([month, value]) => (<div key={month} className="flex items-center gap-2"><div className="text-slate-400 text-xs w-16">{month}</div><div className="flex-1 bg-slate-700 rounded-full h-4"><div className="bg-amber-500 h-full rounded-full" style={{ width: `${(value / maxMonth) * 100}%` }} /></div><div className="text-white text-xs w-20 text-right">{fmt(value)}</div></div>))}</div></div><div className="bg-slate-800 border border-slate-700 rounded-xl p-4"><h3 className="text-white font-semibold mb-3">Top Agenti</h3><div className="space-y-2">{sortedAgenti.map(([agente, value], i) => (<div key={agente} className="flex items-center gap-2"><div className={`w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold ${i === 0 ? 'bg-amber-500 text-slate-900' : 'bg-slate-600 text-white'}`}>{i + 1}</div><div className="text-white text-sm flex-1 truncate">{agente}</div><div className="text-slate-400 text-xs">{fmt(value)}</div></div>))}</div></div></div></div>);
}

function VenditeTab({ sales, allSales, loading, filters, setFilters, uniqueAgenti, updateSale, deleteSale, loadSales, exportToCSV, totals, fmt, selectedSales, toggleSelectSale, selectAllSales, deleteSelectedSales }) {
  return (<><div className="bg-slate-800 border border-slate-700 rounded-xl p-3 mb-4"><div className="flex flex-wrap gap-2 items-center"><button onClick={loadSales} className="bg-slate-700 text-white rounded-lg px-3 py-2"><RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} /></button><button onClick={exportToCSV} className="bg-emerald-500 text-white rounded-lg px-3 py-2 flex items-center gap-1 text-sm"><Download className="w-4 h-4" />CSV</button>{selectedSales.length > 0 && (<button onClick={deleteSelectedSales} className="bg-red-500 text-white rounded-lg px-3 py-2 flex items-center gap-1 text-sm"><Trash2 className="w-4 h-4" />{selectedSales.length}</button>)}<div className="flex-1" /><div className="relative"><Search className="w-4 h-4 absolute left-2 top-1/2 -translate-y-1/2 text-slate-400" /><input type="text" placeholder="Cerca..." value={filters.search} onChange={(e) => setFilters({ ...filters, search: e.target.value })} className="bg-slate-700 border border-slate-600 rounded-lg pl-8 pr-3 py-2 text-white text-sm w-32" /></div><select value={filters.stato} onChange={(e) => setFilters({ ...filters, stato: e.target.value })} className="bg-slate-700 border border-slate-600 rounded-lg px-2 py-2 text-white text-sm"><option value="">Stato</option>{pipelineStati.map(s => <option key={s} value={s}>{s}</option>)}</select>{(filters.search || filters.stato || filters.agente || filters.pagato) && (<button onClick={() => setFilters({ search: '', stato: '', agente: '', zona: '', pagato: '' })} className="text-slate-400"><X className="w-5 h-5" /></button>)}</div></div><div className="grid grid-cols-4 md:grid-cols-7 gap-2 mb-4"><div className="bg-slate-800 border border-slate-700 rounded-lg p-2"><div className="text-slate-400 text-xs">Lead</div><div className="text-lg font-bold text-white">{sales.length}</div></div><div className="bg-slate-800 border border-slate-700 rounded-lg p-2"><div className="text-slate-400 text-xs">Valore</div><div className="text-sm font-bold text-white">{fmt(totals.valore)}</div></div><div className="bg-slate-800 border border-slate-700 rounded-lg p-2"><div className="text-slate-400 text-xs">Comm</div><div className="text-sm font-bold text-amber-400">{fmt(totals.comm)}</div></div><div className="bg-slate-800 border border-slate-700 rounded-lg p-2"><div className="text-slate-400 text-xs">Ag 70%</div><div className="text-sm font-bold text-blue-400">{fmt(totals.ag)}</div></div><div className="hidden md:block bg-slate-800 border border-slate-700 rounded-lg p-2"><div className="text-slate-400 text-xs">Segn 30%</div><div className="text-sm font-bold text-emerald-400">{fmt(totals.sg)}</div></div><div className="hidden md:block bg-green-900/50 border border-green-700 rounded-lg p-2"><div className="text-green-300 text-xs">Pell</div><div className="text-sm font-bold text-green-400">{fmt(totals.pell)}</div></div><div className="hidden md:block bg-orange-900/50 border border-orange-700 rounded-lg p-2"><div className="text-orange-300 text-xs">Giov</div><div className="text-sm font-bold text-orange-400">{fmt(totals.giov)}</div></div></div><div className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-sm"><thead><tr className="bg-slate-700/50 text-left"><th className="px-2 py-2"><button onClick={selectAllSales}>{selectedSales.length === sales.length && sales.length > 0 ? <CheckSquare className="w-4 h-4 text-amber-400" /> : <Square className="w-4 h-4 text-slate-400" />}</button></th><th className="text-slate-300 px-2 py-2">Data</th><th className="text-slate-300 px-2 py-2">Progetto</th><th className="text-slate-300 px-2 py-2">Agente</th><th className="text-slate-300 px-2 py-2 text-right">Valore</th><th className="text-slate-300 px-2 py-2 text-center">%</th><th className="text-slate-300 px-2 py-2 text-center">Stato</th><th className="text-slate-300 px-2 py-2 text-center">Ref</th><th className="text-slate-300 px-2 py-2 text-center">üí∞</th><th className="text-slate-300 px-2 py-2 text-center">üóëÔ∏è</th></tr></thead><tbody>{sales.map(s => (<tr key={s.id} className={`border-t border-slate-700 hover:bg-slate-700/30 ${selectedSales.includes(s.id) ? 'bg-amber-500/10' : ''}`}><td className="px-2 py-2"><button onClick={() => toggleSelectSale(s.id)}>{selectedSales.includes(s.id) ? <CheckSquare className="w-4 h-4 text-amber-400" /> : <Square className="w-4 h-4 text-slate-400" />}</button></td><td className="px-2 py-2 text-white text-xs">{new Date(s.data).toLocaleDateString('it-IT')}</td><td className="px-2 py-2"><div className="text-white text-xs">{s.progetto}</div><div className="text-slate-500 text-xs">{s.developer}</div></td><td className="px-2 py-2 text-blue-400 text-xs">{s.agente || '-'}</td><td className="px-2 py-2 text-amber-400 text-right text-xs">{s.valore > 0 ? fmt(s.valore) : '-'}</td><td className="px-2 py-2 text-center"><select value={s.commission_pct || 5} onChange={(e) => updateSale(s.id, { commission_pct: parseInt(e.target.value) })} className="bg-slate-700 border-0 rounded px-1 py-0.5 text-white text-xs w-12">{commissions.map(c => <option key={c} value={c}>{c}%</option>)}</select></td><td className="px-2 py-2 text-center"><select value={s.stato || 'lead'} onChange={(e) => updateSale(s.id, { stato: e.target.value })} className={`${pipelineColors[s.stato || 'lead']} border-0 rounded px-1 py-0.5 text-white text-xs`}>{pipelineStati.map(st => <option key={st} value={st} className="bg-slate-800">{st}</option>)}</select></td><td className="px-2 py-2 text-center"><select value={s.referente || ''} onChange={(e) => updateSale(s.id, { referente: e.target.value || null })} className={`bg-slate-700 border rounded px-1 py-0.5 text-xs w-12 ${s.referente ? 'border-emerald-500 text-emerald-400' : 'border-red-500 text-red-400'}`}><option value="">-</option><option value="Pellegrino">P</option><option value="Giovanni">G</option></select></td><td className="px-2 py-2 text-center"><button onClick={() => updateSale(s.id, { pagato: !s.pagato })} className={`px-1.5 py-0.5 rounded text-xs ${s.pagato ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>{s.pagato ? '‚úì' : '‚úó'}</button></td><td className="px-2 py-2 text-center"><button onClick={() => deleteSale(s.id)} className="text-red-400"><Trash2 className="w-4 h-4" /></button></td></tr>))}</tbody></table></div></div></>);
}

function PipelineTab({ sales, byStato, updateSale, fmt, pipelineColors, pipelineLabels }) {
  return (<div className="grid grid-cols-2 md:grid-cols-5 gap-2">{pipelineStati.map(stato => (<div key={stato} className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden"><div className={`${pipelineColors[stato]} px-3 py-2 text-white font-semibold text-xs flex justify-between`}><span>{pipelineLabels[stato]}</span><span className="bg-white/20 px-1.5 rounded">{byStato[stato]?.length || 0}</span></div><div className="p-2 space-y-2 max-h-[60vh] overflow-y-auto">{byStato[stato]?.map(sale => (<div key={sale.id} className="bg-slate-700/50 rounded-lg p-2"><div className="text-white text-xs font-medium truncate">{sale.progetto}</div><div className="text-slate-400 text-xs truncate">{sale.agente || sale.segnalatore}</div>{sale.valore > 0 && <div className="text-amber-400 text-xs mt-1">{fmt(sale.valore)}</div>}</div>))}{(!byStato[stato] || byStato[stato].length === 0) && <div className="text-slate-500 text-xs text-center py-4">-</div>}</div></div>))}</div>);
}

function ClientiTab({ clienti, loadClienti, createCliente, updateCliente, deleteCliente, showModal, setShowModal, editingCliente, setEditingCliente, sales }) {
  const [search, setSearch] = useState('');
  const filtered = clienti.filter(c => !search || `${c.nome} ${c.cognome} ${c.email}`.toLowerCase().includes(search.toLowerCase()));
  return (<><div className="flex flex-wrap gap-2 items-center mb-4"><button onClick={() => { setEditingCliente(null); setShowModal(true); }} className="bg-amber-500 text-slate-900 rounded-lg px-3 py-2 flex items-center gap-1 text-sm font-semibold"><UserPlus className="w-4 h-4" />Nuovo</button><button onClick={loadClienti} className="bg-slate-700 text-white rounded-lg px-3 py-2"><RefreshCw className="w-4 h-4" /></button><div className="flex-1" /><div className="relative"><Search className="w-4 h-4 absolute left-2 top-1/2 -translate-y-1/2 text-slate-400" /><input type="text" placeholder="Cerca..." value={search} onChange={(e) => setSearch(e.target.value)} className="bg-slate-700 border border-slate-600 rounded-lg pl-8 pr-3 py-2 text-white text-sm" /></div></div><div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">{filtered.map(cliente => (<div key={cliente.id} className="bg-slate-800 border border-slate-700 rounded-xl p-3"><div className="flex justify-between items-start mb-2"><div><div className="text-white font-medium text-sm">{cliente.nome} {cliente.cognome}</div><div className="text-slate-400 text-xs">{cliente.nazionalita}</div></div><span className={`px-2 py-0.5 rounded text-xs ${cliente.stato === 'acquistato' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-600 text-slate-300'}`}>{cliente.stato}</span></div>{cliente.telefono && <div className="flex items-center gap-1 text-slate-400 text-xs"><Phone className="w-3 h-3" />{cliente.telefono}</div>}{cliente.email && <div className="flex items-center gap-1 text-slate-400 text-xs"><Mail className="w-3 h-3" />{cliente.email}</div>}<div className="flex gap-2 mt-3"><button onClick={() => { setEditingCliente(cliente); setShowModal(true); }} className="flex-1 bg-slate-700 text-white rounded-lg py-1.5 text-xs"><Edit2 className="w-3 h-3 inline mr-1" />Edit</button><button onClick={() => deleteCliente(cliente.id)} className="bg-red-500/20 text-red-400 rounded-lg px-3 py-1.5"><Trash2 className="w-3 h-3" /></button></div></div>))}</div>{showModal && <ClienteModal cliente={editingCliente} onClose={() => { setShowModal(false); setEditingCliente(null); }} onSave={editingCliente ? (data) => updateCliente(editingCliente.id, data) : createCliente} />}</>);
}

function ClienteModal({ cliente, onClose, onSave }) {
  const [form, setForm] = useState(cliente || { nome: '', cognome: '', email: '', telefono: '', whatsapp: '', nazionalita: '', note: '', budget_min: '', budget_max: '', fonte: '', stato: 'nuovo' });
  const handleSubmit = async () => { if (!form.nome) { alert('Nome obbligatorio'); return; } await onSave(form); };
  const inp = "w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white text-sm";
  return (<div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50"><div className="bg-slate-800 rounded-2xl p-6 max-w-md w-full border border-slate-700 max-h-[90vh] overflow-y-auto"><h3 className="text-xl font-semibold text-white mb-4">{cliente ? 'Modifica' : 'Nuovo'} Cliente</h3><div className="space-y-3"><div className="grid grid-cols-2 gap-3"><input type="text" placeholder="Nome *" value={form.nome} onChange={(e) => setForm({ ...form, nome: e.target.value })} className={inp} /><input type="text" placeholder="Cognome" value={form.cognome || ''} onChange={(e) => setForm({ ...form, cognome: e.target.value })} className={inp} /></div><div className="grid grid-cols-2 gap-3"><input type="email" placeholder="Email" value={form.email || ''} onChange={(e) => setForm({ ...form, email: e.target.value })} className={inp} /><input type="tel" placeholder="Telefono" value={form.telefono || ''} onChange={(e) => setForm({ ...form, telefono: e.target.value })} className={inp} /></div><select value={form.stato || 'nuovo'} onChange={(e) => setForm({ ...form, stato: e.target.value })} className={inp}>{clienteStati.map(s => <option key={s} value={s}>{s}</option>)}</select><textarea placeholder="Note" value={form.note || ''} onChange={(e) => setForm({ ...form, note: e.target.value })} className={`${inp} h-20`} /></div><div className="flex gap-3 mt-4"><button onClick={onClose} className="flex-1 bg-slate-700 text-white rounded-xl py-3">Annulla</button><button onClick={handleSubmit} className="flex-1 bg-amber-500 text-slate-900 rounded-xl py-3 font-semibold">Salva</button></div></div></div>);
}

function LoginPage({ onLogin, loading, error, setError }) {
  const [username, setUsername] = useState(''); const [password, setPassword] = useState(''); const [showPw, setShowPw] = useState(false);
  return (<div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4"><div className="max-w-sm w-full"><div className="text-center mb-10 flex flex-col items-center"><img src="/logo.png" alt="KeyPrime" className="h-20 mb-4" /><p className="text-slate-400">Sales Management</p></div>{error && <div className="bg-red-500/20 border border-red-500/50 text-red-300 rounded-xl px-4 py-3 mb-4 flex items-center gap-2"><AlertCircle className="w-5 h-5" /><span>{error}</span><button onClick={() => setError(null)} className="ml-auto">‚úï</button></div>}<div className="bg-slate-800/50 border border-slate-700 rounded-2xl p-6"><form onSubmit={(e) => { e.preventDefault(); onLogin(username, password); }} className="space-y-4"><div><label className="block text-slate-300 text-sm mb-2">Username</label><input type="text" value={username} onChange={(e) => setUsername(e.target.value)} className="w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white" /></div><div><label className="block text-slate-300 text-sm mb-2">Password</label><div className="relative"><input type={showPw ? 'text' : 'password'} value={password} onChange={(e) => setPassword(e.target.value)} className="w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 pr-12 text-white" /><button type="button" onClick={() => setShowPw(!showPw)} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">{showPw ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}</button></div></div><button type="submit" disabled={loading || !username || !password} className="w-full bg-amber-500 hover:bg-amber-600 disabled:bg-slate-600 text-slate-900 rounded-xl py-3 font-semibold mt-4">{loading ? '...' : 'Accedi'}</button></form></div></div></div>);
}

function UserManagement({ users, loadUsers, createUser, updateUser, deleteUser, showUserModal, setShowUserModal, editingUser, setEditingUser }) {
  const [copiedId, setCopiedId] = useState(null);
  const copyCredentials = (u) => { navigator.clipboard.writeText(`KeyPrime\nLink: ${getBaseUrl()}\nUsername: ${u.username}\nPassword: ${u.password}`); setCopiedId(u.id); setTimeout(() => setCopiedId(null), 2000); };
  return (<div><div className="flex justify-between items-center mb-6"><h2 className="text-xl font-semibold text-white">Gestione Utenti</h2><button onClick={() => { setEditingUser(null); setShowUserModal(true); }} className="bg-amber-500 text-slate-900 rounded-xl px-4 py-2 flex items-center gap-2 font-semibold"><UserPlus className="w-4 h-4" /> Nuovo</button></div><div className="grid gap-3">{users.map(u => (<div key={u.id} className="bg-slate-800 border border-slate-700 rounded-xl p-4"><div className="flex justify-between items-start"><div><div className="flex items-center gap-2"><span className="text-white font-medium">{u.nome}</span><span className={`px-2 py-0.5 rounded text-xs ${u.ruolo === 'admin' ? 'bg-amber-500/20 text-amber-400' : u.ruolo === 'agente' ? 'bg-blue-500/20 text-blue-400' : 'bg-emerald-500/20 text-emerald-400'}`}>{u.ruolo}</span></div><div className="text-slate-400 text-sm mt-1">User: <span className="text-white">{u.username}</span> ‚Ä¢ Pw: <span className="text-white">{u.password}</span>{u.email && <> ‚Ä¢ <span className="text-white">{u.email}</span></>}</div></div><div className="flex gap-2"><button onClick={() => copyCredentials(u)} className="bg-slate-700 text-white rounded-lg px-3 py-2 text-sm flex items-center gap-1">{copiedId === u.id ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}</button><button onClick={() => { setEditingUser(u); setShowUserModal(true); }} className="bg-blue-500/20 text-blue-400 rounded-lg px-3 py-2"><Edit2 className="w-4 h-4" /></button>{u.ruolo !== 'admin' && (<button onClick={() => deleteUser(u.id)} className="bg-red-500/20 text-red-400 rounded-lg px-3 py-2"><Trash2 className="w-4 h-4" /></button>)}</div></div></div>))}</div>{showUserModal && <UserModal user={editingUser} onClose={() => { setShowUserModal(false); setEditingUser(null); }} onSave={editingUser ? (data) => updateUser(editingUser.id, data) : createUser} />}</div>);
}

function UserModal({ user, onClose, onSave }) {
  const [form, setForm] = useState(user || { nome: '', username: '', password: '', email: '', ruolo: 'agente', referente: 'Pellegrino', attivo: true });
  const handleSubmit = async () => { if (!form.nome || !form.username || !form.password) { alert('Compila nome, username e password'); return; } const ok = await onSave(form); if (ok) onClose(); };
  const inp = "w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white";
  return (<div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50"><div className="bg-slate-800 rounded-2xl p-6 max-w-md w-full border border-slate-700"><h3 className="text-xl font-semibold text-white mb-4">{user ? 'Modifica' : 'Nuovo'} Utente</h3><div className="space-y-4"><div><label className="block text-slate-300 text-sm mb-2">Nome *</label><input type="text" value={form.nome} onChange={(e) => setForm({ ...form, nome: e.target.value })} className={inp} /></div><div><label className="block text-slate-300 text-sm mb-2">Email</label><input type="email" value={form.email || ''} onChange={(e) => setForm({ ...form, email: e.target.value })} className={inp} /></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-slate-300 text-sm mb-2">Username *</label><input type="text" value={form.username} onChange={(e) => setForm({ ...form, username: e.target.value })} className={inp} /></div><div><label className="block text-slate-300 text-sm mb-2">Password *</label><input type="text" value={form.password} onChange={(e) => setForm({ ...form, password: e.target.value })} className={inp} /></div></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-slate-300 text-sm mb-2">Ruolo</label><select value={form.ruolo} onChange={(e) => setForm({ ...form, ruolo: e.target.value })} className={inp}><option value="agente">Agente</option><option value="segnalatore">Segnalatore</option></select></div><div><label className="block text-slate-300 text-sm mb-2">Referente</label><select value={form.referente} onChange={(e) => setForm({ ...form, referente: e.target.value })} className={inp}><option value="Pellegrino">Pellegrino</option><option value="Giovanni">Giovanni</option></select></div></div>{user && (<div className="flex items-center gap-3"><input type="checkbox" id="attivo" checked={form.attivo} onChange={(e) => setForm({ ...form, attivo: e.target.checked })} className="w-4 h-4" /><label htmlFor="attivo" className="text-slate-300">Utente attivo</label></div>)}<div className="flex gap-3 pt-4"><button onClick={onClose} className="flex-1 bg-slate-700 text-white rounded-xl py-3">Annulla</button><button onClick={handleSubmit} className="flex-1 bg-amber-500 text-slate-900 rounded-xl py-3 font-semibold">Salva</button></div></div></div></div>);
}
