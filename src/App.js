import React, { useState, useEffect } from â€˜reactâ€™;
import { createClient } from â€˜@supabase/supabase-jsâ€™;
import { Download, Trash2, Check, RefreshCw, AlertCircle, LogOut, Eye, EyeOff, Copy, UserPlus, Search, Phone, Mail, X, Edit2, TrendingUp, DollarSign, Target, UserCheck, Menu, Key, CheckSquare, Square, Bell, MapPin, Award, User, MessageCircle, Filter, ChevronLeft, Globe } from â€˜lucide-reactâ€™;

const supabase = createClient(â€˜https://wqtylxrrerhbxagdzftn.supabase.coâ€™,â€˜eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxdHlseHJyZXJoYnhhZ2R6ZnRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjkyNjAsImV4cCI6MjA4NzI0NTI2MH0.oXUs9ITNi6lEFat_5FH0x-Exw5MDgRhwx6T0yL3xiWQâ€™);

const RESEND_API_KEY = â€˜re_jCpLJKfw_MfWu2jbSzPPgz6pLHQXMAXJbâ€™;
const EMAIL_FROM = â€˜onboarding@resend.devâ€™;
const zones = [â€˜Palm Jumeirahâ€™, â€˜Dubai Marinaâ€™, â€˜Downtownâ€™, â€˜Dubai Creekâ€™, â€˜JBRâ€™, â€˜Business Bayâ€™, â€˜JLTâ€™, â€˜DIFCâ€™, â€˜MBR Cityâ€™, â€˜Dubai Hillsâ€™, â€˜Altroâ€™];
const developers = [â€˜Emaarâ€™, â€˜Damacâ€™, â€˜Sobhaâ€™, â€˜Meraasâ€™, â€˜Nakheelâ€™, â€˜Dubai Propertiesâ€™, â€˜Aziziâ€™, â€˜Danubeâ€™, â€˜Binghattiâ€™, â€˜Altroâ€™];
const commissions = [2, 4, 5, 6];
const pipelineStati = [â€˜leadâ€™, â€˜trattativaâ€™, â€˜prenotatoâ€™, â€˜vendutoâ€™, â€˜incassatoâ€™];
const pipelineColors = { lead: â€˜bg-slate-500â€™, trattativa: â€˜bg-blue-500â€™, prenotato: â€˜bg-amber-500â€™, venduto: â€˜bg-emerald-500â€™, incassato: â€˜bg-green-600â€™ };
const pipelineLabels = { lead: â€˜ğŸ¯ Leadâ€™, trattativa: â€˜ğŸ’¬ Trattativaâ€™, prenotato: â€˜ğŸ“ Prenotatoâ€™, venduto: â€˜âœ… Vendutoâ€™, incassato: â€˜ğŸ’° Incassatoâ€™ };
const clienteStati = [â€˜nuovoâ€™, â€˜contattatoâ€™, â€˜interessatoâ€™, â€˜trattativaâ€™, â€˜acquistatoâ€™, â€˜persoâ€™];
const clienteStatiColors = { nuovo: â€˜bg-slate-500â€™, contattato: â€˜bg-blue-500â€™, interessato: â€˜bg-amber-500â€™, trattativa: â€˜bg-purple-500â€™, acquistato: â€˜bg-emerald-500â€™, perso: â€˜bg-red-500â€™ };
const fmt = (n) => (n || 0).toLocaleString(â€˜en-AEâ€™, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
const fmtDate = (d) => d ? new Date(d).toLocaleDateString(â€˜it-ITâ€™, { day: â€˜2-digitâ€™, month: â€˜shortâ€™, year: â€˜numericâ€™ }) : â€˜-â€™;
const getWhatsAppLink = (phone, msg = â€˜â€™) => `https://wa.me/${(phone || '').replace(/\D/g, '')}${msg ? `?text=${encodeURIComponent(msg)}` : ''}`;
const getBaseUrl = () => typeof window !== â€˜undefinedâ€™ ? window.location.origin : â€˜â€™;

const sendEmail = async (to, subject, html) => { try { await fetch(â€˜https://api.resend.com/emailsâ€™, { method: â€˜POSTâ€™, headers: { â€˜Authorizationâ€™: `Bearer ${RESEND_API_KEY}`, â€˜Content-Typeâ€™: â€˜application/jsonâ€™ }, body: JSON.stringify({ from: EMAIL_FROM, to: [to], subject, html }) }); } catch (e) {} };

const Logo = ({ size = â€˜largeâ€™, centered = false }) => <div className={centered ? â€˜flex justify-center w-fullâ€™ : â€˜â€™}><img src=â€/logo.pngâ€ alt=â€œKeyPrimeâ€ className={size === â€˜largeâ€™ ? â€˜h-16 sm:h-20 md:h-24 w-auto max-w-[250px]â€™ : â€˜h-10 md:h-12 w-autoâ€™} style={{ objectFit: â€˜containâ€™ }} /></div>;

const MobileMenu = ({ isOpen, onClose, tabs, activeTab, setActiveTab, user, onLogout }) => { if (!isOpen) return null; return <div className="fixed inset-0 z-50"><div className="absolute inset-0 bg-black/70" onClick={onClose} /><div className="absolute left-0 top-0 bottom-0 w-72 bg-slate-800 border-r border-slate-700 p-4 flex flex-col"><div className="flex items-center justify-between mb-6"><Logo size="small" /><button onClick={onClose} className="text-slate-400"><X className="w-6 h-6" /></button></div><div className="space-y-2 flex-1">{tabs.map(t => <button key={t.id} onClick={() => { setActiveTab(t.id); onClose(); }} className={`w-full text-left px-4 py-3 rounded-xl font-medium ${activeTab === t.id ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-white'}`}>{t.icon} {t.label}</button>)}</div><div className="border-t border-slate-700 pt-4"><div className="bg-slate-700/50 rounded-xl p-4 mb-4"><div className="text-slate-400 text-sm">{user?.ruolo}</div><div className="text-white font-medium">{user?.nome}</div></div><button onClick={onLogout} className="w-full bg-red-500/20 text-red-400 rounded-xl py-3 flex items-center justify-center gap-2"><LogOut className="w-5 h-5" /> Esci</button></div></div></div>; };

const SelectWithOther = ({ value, onChange, options, placeholder, className }) => { const [showCustom, setShowCustom] = useState(false); const [cv, setCv] = useState(â€™â€™); useEffect(() => { if (value && !options.includes(value) && value !== â€˜Altroâ€™) { setShowCustom(true); setCv(value); } }, [value, options]); return <div className="space-y-2"><select value={showCustom ? â€˜Altroâ€™ : value} onChange={(e) => { if (e.target.value === â€˜Altroâ€™) { setShowCustom(true); setCv(â€™â€™); onChange(â€™â€™); } else { setShowCustom(false); onChange(e.target.value); }}} className={className}><option value="">{placeholder}</option>{options.map(o => <option key={o} value={o}>{o}</option>)}</select>{showCustom && <input type=â€œtextâ€ value={cv} onChange={(e) => { setCv(e.target.value); onChange(e.target.value); }} placeholder=â€œSpecificaâ€¦â€ className={className} autoFocus />}</div>; };

const ClientSearch = ({ clienti, onSelect, onCreateNew, selectedClient }) => { const [search, setSearch] = useState(â€™â€™); const [show, setShow] = useState(false); const filtered = search.length >= 2 ? clienti.filter(c => `${c.nome} ${c.cognome} ${c.telefono}`.toLowerCase().includes(search.toLowerCase())).slice(0, 5) : []; return <div className="relative">{selectedClient ? <div className="bg-emerald-900/30 border border-emerald-500/50 rounded-xl p-3 flex items-center justify-between"><div><div className="text-white font-medium">{selectedClient.nome} {selectedClient.cognome}</div><div className="text-emerald-400 text-xs">{selectedClient.telefono}</div></div><button onClick={() => onSelect(null)} className=â€œtext-slate-400â€><X className="w-5 h-5" /></button></div> : <><div className="relative"><Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" /><input type=â€œtextâ€ placeholder=â€œCerca clienteâ€¦â€ value={search} onChange={(e) => { setSearch(e.target.value); setShow(true); }} onFocus={() => setShow(true)} className=â€œw-full bg-slate-800 border border-slate-700 rounded-xl pl-10 pr-4 py-3 text-white text-smâ€ /></div>{show && search.length >= 2 && <div className="absolute z-10 w-full mt-1 bg-slate-800 border border-slate-700 rounded-xl overflow-hidden shadow-xl">{filtered.map(c => <button key={c.id} onClick={() => { onSelect(c); setSearch(â€™â€™); setShow(false); }} className=â€œw-full text-left px-4 py-3 hover:bg-slate-700 border-b border-slate-700 last:border-0â€><div className="text-white text-sm">{c.nome} {c.cognome}</div><div className="text-slate-400 text-xs">{c.telefono}</div></button>)}{filtered.length === 0 && <div className="px-4 py-3 text-slate-400 text-sm">Nessuno</div>}<button onClick={() => { onCreateNew(); setShow(false); }} className=â€œw-full text-left px-4 py-3 bg-blue-900/30 text-blue-400 flex items-center gap-2â€><UserPlus className="w-4 h-4" /> Nuovo</button></div>}{!search && <button onClick={onCreateNew} className="w-full mt-2 bg-slate-700/50 border border-dashed border-slate-600 rounded-xl py-3 text-slate-400 text-sm flex items-center justify-center gap-2"><UserPlus className="w-4 h-4" /> Nuovo cliente</button>}</>}</div>; };

export default function App() {
const [view, setView] = useState(â€˜loginâ€™);
const [user, setUser] = useState(null);
const [sales, setSales] = useState([]);
const [users, setUsers] = useState([]);
const [clienti, setClienti] = useState([]);
const [loading, setLoading] = useState(false);
const [error, setError] = useState(null);
const [showForm, setShowForm] = useState(null);
const [saveStatus, setSaveStatus] = useState(â€™â€™);
const [showUserModal, setShowUserModal] = useState(false);
const [showClienteModal, setShowClienteModal] = useState(false);
const [editingCliente, setEditingCliente] = useState(null);
const [editingUser, setEditingUser] = useState(null);
const [adminTab, setAdminTab] = useState(â€˜dashboardâ€™);
const [filters, setFilters] = useState({ search: â€˜â€™, stato: â€˜â€™ });
const [convertingSale, setConvertingSale] = useState(null);
const [agentTab, setAgentTab] = useState(â€˜listaâ€™);
const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
const [selectedSales, setSelectedSales] = useState([]);
const [selectedUsers, setSelectedUsers] = useState([]);
const [selectedClienti, setSelectedClienti] = useState([]);
const [showPasswordModal, setShowPasswordModal] = useState(false);
const [selectedCliente, setSelectedCliente] = useState(null);
const [clienteFilters, setClienteFilters] = useState({ search: â€˜â€™, stato: â€˜â€™, budgetMin: â€˜â€™, budgetMax: â€˜â€™, agente: â€˜â€™ });
const [showFilters, setShowFilters] = useState(false);

useEffect(() => { const s = localStorage.getItem(â€˜keyprime_userâ€™); if (s) { const u = JSON.parse(s); setUser(u); setView(u.ruolo === â€˜adminâ€™ ? â€˜adminâ€™ : u.ruolo); } }, []);

const loadSales = async () => { setLoading(true); const { data } = await supabase.from(â€˜sales_with_commissionsâ€™).select(â€™*â€™).order(â€˜created_atâ€™, { ascending: false }); setSales(data || []); setLoading(false); };
const loadUsers = async () => { const { data } = await supabase.from(â€˜user_credentialsâ€™).select(â€™*â€™).order(â€˜created_atâ€™, { ascending: false }); setUsers(data || []); };
const loadClienti = async () => { const { data } = await supabase.from(â€˜clientiâ€™).select(â€™*â€™).order(â€˜created_atâ€™, { ascending: false }); setClienti(data || []); };

useEffect(() => { if (user) { loadSales(); loadClienti(); if (user.ruolo === â€˜adminâ€™) loadUsers(); }}, [user]);

const handleLogin = async (username, password) => { setLoading(true); setError(null); const { data } = await supabase.from(â€˜user_credentialsâ€™).select(â€™*â€™).eq(â€˜usernameâ€™, username).eq(â€˜passwordâ€™, password).eq(â€˜attivoâ€™, true).single(); if (!data) { setError(â€˜Credenziali non valideâ€™); setLoading(false); return; } setUser(data); localStorage.setItem(â€˜keyprime_userâ€™, JSON.stringify(data)); setView(data.ruolo === â€˜adminâ€™ ? â€˜adminâ€™ : data.ruolo); setLoading(false); };
const handleLogout = () => { setUser(null); localStorage.removeItem(â€˜keyprime_userâ€™); setView(â€˜loginâ€™); setMobileMenuOpen(false); };
const changePassword = async (np) => { await supabase.from(â€˜user_credentialsâ€™).update({ password: np }).eq(â€˜idâ€™, user.id); const u = { â€¦user, password: np }; setUser(u); localStorage.setItem(â€˜keyprime_userâ€™, JSON.stringify(u)); setShowPasswordModal(false); setSaveStatus(â€˜Password aggiornata!â€™); setTimeout(() => setSaveStatus(â€™â€™), 2000); return true; };

const addLead = async (ld) => { setSaveStatus(â€˜Salvataggioâ€¦â€™); let cliente_id = ld.cliente_id; if (!cliente_id && ld.cliente_nome) { const { data: cd } = await supabase.from(â€˜clientiâ€™).insert([{ nome: ld.cliente_nome, cognome: ld.cliente_cognome, email: ld.cliente_email, telefono: ld.cliente_telefono, whatsapp: ld.cliente_whatsapp, nazionalita: ld.cliente_nazionalita, budget_min: ld.cliente_budget_min ? parseFloat(ld.cliente_budget_min) : null, budget_max: ld.cliente_budget_max ? parseFloat(ld.cliente_budget_max) : null, note: ld.cliente_note, stato: â€˜nuovoâ€™, fonte: â€˜Agenteâ€™, agente_riferimento: user?.nome, created_by: user?.nome, referente: user?.referente }]).select().single(); if (cd) cliente_id = cd.id; } const { error: e } = await supabase.from(â€˜salesâ€™).insert([{ data: ld.data, developer: ld.developer, progetto: ld.progetto, zona: ld.zona, valore: ld.valore || 0, agente: ld.agente, segnalatore: ld.segnalatore, referente: user?.referente, commission_pct: 5, inserted_by: user?.nome, inserted_as: user?.ruolo, pagato: false, stato: ld.stato || â€˜leadâ€™, cliente_id }]); if (e) { setSaveStatus(â€˜Errore!â€™); } else { setSaveStatus(â€˜Salvato!â€™); setShowForm(null); loadSales(); loadClienti(); } setTimeout(() => setSaveStatus(â€™â€™), 2000); };

const addSale = async (sd) => { setSaveStatus(â€˜Salvataggioâ€¦â€™); let cliente_id = sd.cliente_id; let cliente_nome = sd.cliente_nome || â€˜â€™; if (!cliente_id && sd.nuovo_cliente_nome) { const { data: cd } = await supabase.from(â€˜clientiâ€™).insert([{ nome: sd.nuovo_cliente_nome, cognome: sd.nuovo_cliente_cognome || â€˜â€™, telefono: sd.nuovo_cliente_telefono || â€˜â€™, email: sd.nuovo_cliente_email || â€˜â€™, stato: â€˜acquistatoâ€™, fonte: â€˜Venditaâ€™, agente_riferimento: user?.nome, created_by: user?.nome, referente: user?.referente }]).select().single(); if (cd) { cliente_id = cd.id; cliente_nome = cd.nome; } } if (sd.cliente_id) await supabase.from(â€˜clientiâ€™).update({ stato: â€˜acquistatoâ€™ }).eq(â€˜idâ€™, sd.cliente_id); const { error: e } = await supabase.from(â€˜salesâ€™).insert([{ data: sd.data, developer: sd.developer, progetto: sd.progetto, zona: sd.zona, valore: sd.valore, agente: sd.agente, segnalatore: sd.segnalatore, cliente_id, cliente_nome, referente: user?.referente, commission_pct: 5, inserted_by: user?.nome, inserted_as: user?.ruolo, pagato: false, stato: â€˜vendutoâ€™ }]); if (e) setSaveStatus(â€˜Errore!â€™); else { setSaveStatus(â€˜Vendita registrata!â€™); setShowForm(null); loadSales(); loadClienti(); } setTimeout(() => setSaveStatus(â€™â€™), 2000); };

const convertLeadToSale = async (id, v) => { setSaveStatus(â€˜Conversioneâ€¦â€™); const sale = sales.find(s => s.id === id); if (sale?.cliente_id) await supabase.from(â€˜clientiâ€™).update({ stato: â€˜acquistatoâ€™ }).eq(â€˜idâ€™, sale.cliente_id); await supabase.from(â€˜salesâ€™).update({ stato: â€˜vendutoâ€™, valore: v }).eq(â€˜idâ€™, id); setSaveStatus(â€˜Convertito!â€™); setConvertingSale(null); loadSales(); loadClienti(); setTimeout(() => setSaveStatus(â€™â€™), 2000); };

const updateSale = async (id, u) => { const s = sales.find(x => x.id === id); if (u.pagato === true && !s?.pagato) { const tn = s.agente || s.segnalatore; if (tn) { const { data: tu } = await supabase.from(â€˜user_credentialsâ€™).select(â€™*â€™).eq(â€˜nomeâ€™, tn).single(); if (tu?.email) { const ca = Number(s.valore) * (s.commission_pct || 5) / 100 * (s.agente ? 0.7 : 0.3); await sendEmail(tu.email, â€˜ğŸ’° Commissioneâ€™, `<h2>Pagata!</h2><p>${s.progetto}: ${fmt(ca)} AED</p>`); }}} await supabase.from(â€˜salesâ€™).update(u).eq(â€˜idâ€™, id); loadSales(); };
const deleteSale = async (id) => { if (!window.confirm(â€˜Eliminare?â€™)) return; await supabase.from(â€˜salesâ€™).delete().eq(â€˜idâ€™, id); loadSales(); };
const deleteSelectedSales = async () => { if (!selectedSales.length || !window.confirm(`Eliminare ${selectedSales.length}?`)) return; for (const id of selectedSales) await supabase.from(â€˜salesâ€™).delete().eq(â€˜idâ€™, id); setSelectedSales([]); loadSales(); };
const toggleSelectSale = (id) => setSelectedSales(p => p.includes(id) ? p.filter(x => x !== id) : [â€¦p, id]);
const selectAllSales = () => setSelectedSales(selectedSales.length === filteredSales.length ? [] : filteredSales.map(s => s.id));

const createUser = async (d) => { const { error: e } = await supabase.from(â€˜user_credentialsâ€™).insert([d]); if (e) return false; loadUsers(); setShowUserModal(false); return true; };
const updateUser = async (id, d) => { await supabase.from(â€˜user_credentialsâ€™).update(d).eq(â€˜idâ€™, id); loadUsers(); setShowUserModal(false); setEditingUser(null); return true; };
const deleteUser = async (id) => { if (!window.confirm(â€˜Eliminare?â€™)) return; await supabase.from(â€˜user_credentialsâ€™).delete().eq(â€˜idâ€™, id); loadUsers(); };
const deleteSelectedUsers = async () => { if (!selectedUsers.length) return; for (const id of selectedUsers) await supabase.from(â€˜user_credentialsâ€™).delete().eq(â€˜idâ€™, id); setSelectedUsers([]); loadUsers(); };
const toggleSelectUser = (id) => setSelectedUsers(p => p.includes(id) ? p.filter(x => x !== id) : [â€¦p, id]);

const createCliente = async (d) => { await supabase.from(â€˜clientiâ€™).insert([{ â€¦d, created_by: user?.nome, referente: user?.referente }]); loadClienti(); setShowClienteModal(false); return true; };
const updateCliente = async (id, d) => { await supabase.from(â€˜clientiâ€™).update(d).eq(â€˜idâ€™, id); loadClienti(); setShowClienteModal(false); if (selectedCliente?.id === id) setSelectedCliente({ â€¦selectedCliente, â€¦d }); return true; };
const deleteCliente = async (id) => { if (!window.confirm(â€˜Eliminare?â€™)) return; await supabase.from(â€˜clientiâ€™).delete().eq(â€˜idâ€™, id); loadClienti(); if (selectedCliente?.id === id) setSelectedCliente(null); };
const deleteSelectedClienti = async () => { if (!selectedClienti.length) return; for (const id of selectedClienti) await supabase.from(â€˜clientiâ€™).delete().eq(â€˜idâ€™, id); setSelectedClienti([]); loadClienti(); };
const toggleSelectCliente = (id) => setSelectedClienti(p => p.includes(id) ? p.filter(x => x !== id) : [â€¦p, id]);

const exportToCSV = () => { let csv = â€˜\ufeffData,Progetto,Cliente,Agente,Valore,Stato\nâ€™; filteredSales.forEach(s => csv += `${s.data},"${s.progetto}","${s.cliente_nome||''}","${s.agente||''}",${s.valore},${s.stato}\n`); const l = document.createElement(â€˜aâ€™); l.href = URL.createObjectURL(new Blob([csv], { type: â€˜text/csvâ€™ })); l.download = `KeyPrime_${new Date().toISOString().split('T')[0]}.csv`; l.click(); };
const exportClientiToCSV = () => { let csv = â€˜\ufeffNome,Cognome,Telefono,Email,Stato,Budget,Agente\nâ€™; filteredClienti.forEach(c => csv += `"${c.nome}","${c.cognome||''}","${c.telefono||''}","${c.email||''}","${c.stato}",${c.budget_max||''},"${c.agente_riferimento||''}"\n`); const l = document.createElement(â€˜aâ€™); l.href = URL.createObjectURL(new Blob([csv], { type: â€˜text/csvâ€™ })); l.download = `Clienti_${new Date().toISOString().split('T')[0]}.csv`; l.click(); };

const filteredSales = sales.filter(s => { if (filters.search && !`${s.progetto} ${s.developer} ${s.agente} ${s.cliente_nome}`.toLowerCase().includes(filters.search.toLowerCase())) return false; if (filters.stato && s.stato !== filters.stato) return false; return true; });
const filteredClienti = clienti.filter(c => { if (clienteFilters.search && !`${c.nome} ${c.cognome} ${c.email} ${c.telefono}`.toLowerCase().includes(clienteFilters.search.toLowerCase())) return false; if (clienteFilters.stato && c.stato !== clienteFilters.stato) return false; if (clienteFilters.agente && c.agente_riferimento !== clienteFilters.agente) return false; if (clienteFilters.budgetMin && (!c.budget_min || c.budget_min < parseFloat(clienteFilters.budgetMin))) return false; if (clienteFilters.budgetMax && (!c.budget_max || c.budget_max > parseFloat(clienteFilters.budgetMax))) return false; return true; });
const getClientSales = (clienteId) => sales.filter(s => s.cliente_id === clienteId);
const uniqueAgenti = [â€¦new Set(clienti.map(c => c.agente_riferimento).filter(Boolean))];
const ErrorBanner = () => error && <div className="bg-red-500/20 border border-red-500/50 text-red-300 rounded-xl px-4 py-3 mb-4 flex items-center gap-2"><AlertCircle className="w-5 h-5" />{error}<button onClick={() => setError(null)} className=â€œml-autoâ€>âœ•</button></div>;

// LOGIN
if (view === â€˜loginâ€™) return <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-6"><div className="w-full max-w-sm"><div className="text-center mb-8"><Logo size="large" centered /><p className="text-slate-400 text-sm mt-3">Sales Management</p></div>{error && <div className="bg-red-500/20 text-red-300 rounded-xl px-4 py-3 mb-4 text-sm">{error}</div>}<div className="bg-slate-800/50 border border-slate-700 rounded-2xl p-6"><LoginForm onLogin={handleLogin} loading={loading} /></div></div></div>;

// AGENTE / SEGNALATORE
if (view === â€˜agenteâ€™ || view === â€˜segnalatoreâ€™) {
const type = view;
const mySales = sales.filter(s => type === â€˜agenteâ€™ ? s.agente === user?.nome : s.segnalatore === user?.nome);
const rate = type === â€˜agenteâ€™ ? 0.7 : 0.3;
const myVendite = mySales.filter(s => s.stato === â€˜vendutoâ€™ || s.stato === â€˜incassatoâ€™);
const totalComm = myVendite.reduce((sum, s) => sum + (Number(s.valore) * (s.commission_pct || 5) / 100 * rate), 0);
const pagate = myVendite.filter(s => s.pagato).reduce((sum, s) => sum + (Number(s.valore) * (s.commission_pct || 5) / 100 * rate), 0);
const byStato = pipelineStati.reduce((acc, st) => { acc[st] = mySales.filter(s => (s.stato || â€˜leadâ€™) === st); return acc; }, {});
const agentTabs = [{ id: â€˜listaâ€™, icon: â€˜ğŸ“‹â€™, label: â€˜Listaâ€™ }, { id: â€˜pipelineâ€™, icon: â€˜ğŸ¯â€™, label: â€˜Pipelineâ€™ }, { id: â€˜settingsâ€™, icon: â€˜âš™ï¸â€™, label: â€˜Impostazioniâ€™ }];

```
if (showForm) return <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900"><div className="sticky top-0 z-40 bg-slate-900/95 backdrop-blur border-b border-slate-700 px-4 py-3"><div className="flex items-center justify-between max-w-lg mx-auto"><button onClick={() => setShowForm(null)} className="text-slate-400 flex items-center gap-2"><X className="w-5 h-5" />Annulla</button><span className="text-white font-medium">{showForm === 'lead' ? 'Nuovo Lead' : 'Nuova Vendita'}</span><div className="w-16"></div></div></div><div className="p-4 pb-28 max-w-lg mx-auto">{saveStatus && <div className="bg-emerald-500/20 text-emerald-300 rounded-xl px-4 py-2 mb-4 text-center text-sm">{saveStatus}</div>}{showForm === 'lead' && <LeadFormClean type={type} userName={user?.nome} clienti={clienti} onSubmit={addLead} />}{showForm === 'vendita' && <SaleFormClean type={type} userName={user?.nome} clienti={clienti} onSubmit={addSale} />}</div><div className="fixed bottom-0 left-0 right-0 p-4 bg-slate-900/95 backdrop-blur border-t border-slate-700"><button onClick={() => document.getElementById('submitBtn')?.click()} className={`w-full ${showForm === 'lead' ? 'bg-blue-500' : 'bg-emerald-500'} text-white rounded-xl py-4 font-semibold text-lg`}>{showForm === 'lead' ? 'ğŸ’¾ Salva Lead' : 'ğŸ’° Registra Vendita'}</button></div></div>;

return <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900"><div className="sticky top-0 z-40 bg-slate-900/95 backdrop-blur border-b border-slate-700"><div className="flex items-center justify-between px-4 py-3"><div className="flex items-center gap-3"><button onClick={() => setMobileMenuOpen(true)} className="md:hidden text-slate-400"><Menu className="w-6 h-6" /></button><Logo size="small" /></div><div className="hidden md:flex items-center gap-4"><div className="text-right"><div className="text-slate-400 text-xs">{type}</div><div className="text-white text-sm">{user?.nome}</div></div><button onClick={() => setShowPasswordModal(true)} className="text-slate-400"><Key className="w-5 h-5" /></button><button onClick={handleLogout} className="text-slate-400"><LogOut className="w-5 h-5" /></button></div><button onClick={() => setShowPasswordModal(true)} className="md:hidden text-slate-400"><Key className="w-5 h-5" /></button></div></div><MobileMenu isOpen={mobileMenuOpen} onClose={() => setMobileMenuOpen(false)} tabs={agentTabs} activeTab={agentTab} setActiveTab={setAgentTab} user={user} onLogout={handleLogout} /><div className="p-4 max-w-4xl mx-auto"><ErrorBanner />{saveStatus && <div className="bg-emerald-500/20 text-emerald-300 rounded-xl px-4 py-2 mb-4 text-center text-sm">{saveStatus}</div>}<div className="grid grid-cols-4 gap-2 mb-4"><div className="bg-slate-800 border border-slate-700 rounded-xl p-2 text-center"><div className="text-slate-400 text-xs">Lead</div><div className="text-xl font-bold text-white">{mySales.length}</div></div><div className="bg-slate-800 border border-slate-700 rounded-xl p-2 text-center"><div className="text-slate-400 text-xs">Vendite</div><div className="text-xl font-bold text-emerald-400">{myVendite.length}</div></div><div className="bg-emerald-900/30 border border-emerald-700/50 rounded-xl p-2 text-center"><div className="text-emerald-300 text-xs">Pagate</div><div className="text-sm font-bold text-emerald-400">{fmt(pagate)}</div></div><div className="bg-red-900/30 border border-red-700/50 rounded-xl p-2 text-center"><div className="text-red-300 text-xs">Pending</div><div className="text-sm font-bold text-red-400">{fmt(totalComm - pagate)}</div></div></div>{!convertingSale && agentTab !== 'settings' && <div className="grid grid-cols-2 gap-3 mb-4"><button onClick={() => setShowForm('lead')} className="bg-blue-500 text-white rounded-xl p-3 flex items-center justify-center gap-2 font-semibold text-sm"><Target className="w-4 h-4" /> Nuovo Lead</button><button onClick={() => setShowForm('vendita')} className="bg-emerald-500 text-white rounded-xl p-3 flex items-center justify-center gap-2 font-semibold text-sm"><DollarSign className="w-4 h-4" /> Vendita</button></div>}{convertingSale && <ConvertModal sale={convertingSale} onConvert={convertLeadToSale} onCancel={() => setConvertingSale(null)} />}<div className="hidden md:flex gap-2 mb-4">{agentTabs.map(t => <button key={t.id} onClick={() => setAgentTab(t.id)} className={`px-4 py-2 rounded-xl font-medium text-sm ${agentTab === t.id ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-white'}`}>{t.icon} {t.label}</button>)}<div className="flex-1" /><button onClick={loadSales} className="bg-slate-700 text-white rounded-xl px-3 py-2"><RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} /></button></div>{agentTab === 'lista' && (mySales.length === 0 ? <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-8 text-center text-slate-500">Nessun lead</div> : <div className="space-y-3">{mySales.map(s => { const mc = (s.stato === 'venduto' || s.stato === 'incassato') ? Number(s.valore) * (s.commission_pct || 5) / 100 * rate : 0; const cv = ['prenotato', 'trattativa'].includes(s.stato); return <div key={s.id} className="bg-slate-800 border border-slate-700 rounded-xl p-3"><div className="flex justify-between items-start mb-2"><div><div className="flex items-center gap-2"><span className="text-white font-medium text-sm">{s.progetto || 'TBD'}</span><span className={`px-2 py-0.5 rounded text-xs text-white ${pipelineColors[s.stato || 'lead']}`}>{s.stato}</span></div><div className="text-slate-400 text-xs">{s.developer} â€¢ {s.zona}</div>{s.cliente_nome && <div className="text-blue-400 text-xs mt-1">ğŸ‘¤ {s.cliente_nome}</div>}</div><div className="text-right">{s.valore > 0 ? <div className="text-amber-400 font-semibold text-sm">{fmt(s.valore)}</div> : <div className="text-slate-500 text-xs">TBD</div>}</div></div><div className="flex items-center gap-1 py-2 border-t border-slate-700 overflow-x-auto">{pipelineStati.slice(0, -1).map(st => <button key={st} onClick={() => updateSale(s.id, { stato: st })} className={`px-2 py-1 rounded text-xs ${s.stato === st ? `${pipelineColors[st]} text-white` : 'bg-slate-700 text-slate-400'}`}>{st}</button>)}</div><div className="flex justify-between items-center">{mc > 0 ? <div className="text-xs"><span className="text-slate-400">Comm: </span><span className="text-amber-300">{fmt(mc)}</span><span className={`ml-1 px-1.5 py-0.5 rounded ${s.pagato ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>{s.pagato ? 'âœ“' : 'â³'}</span></div> : <span />}{cv && <button onClick={() => setConvertingSale(s)} className="bg-emerald-500 text-white px-2 py-1 rounded text-xs">ğŸ’°</button>}</div></div>; })}</div>)}{agentTab === 'pipeline' && <div className="grid grid-cols-2 md:grid-cols-4 gap-2">{pipelineStati.slice(0, -1).map(st => <div key={st} className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden"><div className={`${pipelineColors[st]} px-2 py-1.5 text-white text-xs flex justify-between`}><span>{st}</span><span className="bg-white/20 px-1.5 rounded">{byStato[st]?.length || 0}</span></div><div className="p-2 space-y-2 max-h-[40vh] overflow-y-auto">{byStato[st]?.map(s => <div key={s.id} className="bg-slate-700/50 rounded-lg p-2"><div className="text-white text-xs truncate">{s.progetto || 'TBD'}</div>{s.cliente_nome && <div className="text-blue-400 text-xs">ğŸ‘¤ {s.cliente_nome}</div>}{s.valore > 0 && <div className="text-amber-400 text-xs">{fmt(s.valore)}</div>}</div>)}{!byStato[st]?.length && <div className="text-slate-500 text-xs text-center py-3">-</div>}</div></div>)}</div>}{agentTab === 'settings' && <div className="bg-slate-800 border border-slate-700 rounded-xl p-4"><h3 className="text-white font-semibold mb-4">Impostazioni</h3><div className="flex justify-between items-center py-3"><div className="text-white text-sm">Password</div><button onClick={() => setShowPasswordModal(true)} className="bg-amber-500 text-slate-900 px-3 py-1.5 rounded-lg text-sm font-medium">Cambia</button></div></div>}</div>{showPasswordModal && <PasswordModal currentPassword={user?.password} onSave={changePassword} onClose={() => setShowPasswordModal(false)} />}</div>;
```

}

// ADMIN
if (view === â€˜adminâ€™) {
const vendite = sales.filter(s => s.stato === â€˜vendutoâ€™ || s.stato === â€˜incassatoâ€™);
const totals = sales.reduce((a, s) => { const c = Number(s.valore) * (s.commission_pct || 5) / 100; const ag = s.agente ? c * 0.7 : 0; const sg = s.segnalatore ? c * 0.3 : 0; const n = c - ag - sg; const p = s.referente === â€˜Pellegrinoâ€™ ? n * 0.7 : (s.referente === â€˜Giovanniâ€™ ? n * 0.3 : 0); const g = s.referente === â€˜Giovanniâ€™ ? n * 0.7 : (s.referente === â€˜Pellegrinoâ€™ ? n * 0.3 : 0); return { valore: a.valore + Number(s.valore), comm: a.comm + c, ag: a.ag + ag, sg: a.sg + sg, netto: a.netto + n, pell: a.pell + p, giov: a.giov + g }; }, { valore: 0, comm: 0, ag: 0, sg: 0, netto: 0, pell: 0, giov: 0 });
const byStato = pipelineStati.reduce((a, st) => { a[st] = sales.filter(s => (s.stato || â€˜leadâ€™) === st); return a; }, {});
const byMonth = sales.reduce((a, s) => { const m = s.data?.substring(0, 7) || â€˜N/Aâ€™; a[m] = (a[m] || 0) + Number(s.valore); return a; }, {});
const byAgente = sales.reduce((a, s) => { if (s.agente) a[s.agente] = (a[s.agente] || 0) + Number(s.valore); return a; }, {});
const byZona = sales.reduce((a, s) => { if (s.zona) a[s.zona] = (a[s.zona] || 0) + Number(s.valore); return a; }, {});
const adminTabs = [{ id: â€˜dashboardâ€™, icon: â€˜ğŸ“Šâ€™, label: â€˜Dashboardâ€™ }, { id: â€˜venditeâ€™, icon: â€˜ğŸ’°â€™, label: â€˜Venditeâ€™ }, { id: â€˜pipelineâ€™, icon: â€˜ğŸ¯â€™, label: â€˜Pipelineâ€™ }, { id: â€˜clientiâ€™, icon: â€˜ğŸ‘¥â€™, label: â€˜CRMâ€™ }, { id: â€˜utentiâ€™, icon: â€˜âš™ï¸â€™, label: â€˜Utentiâ€™ }];

```
return <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900"><div className="sticky top-0 z-40 bg-slate-900/95 backdrop-blur border-b border-slate-700"><div className="flex items-center justify-between px-4 py-3 max-w-7xl mx-auto"><div className="flex items-center gap-3"><button onClick={() => setMobileMenuOpen(true)} className="md:hidden text-slate-400"><Menu className="w-6 h-6" /></button><Logo size="small" /></div><div className="hidden md:flex items-center gap-4"><div className="text-right"><div className="text-slate-400 text-xs">Admin</div><div className="text-white text-sm">{user?.nome}</div></div><button onClick={handleLogout} className="text-slate-400"><LogOut className="w-5 h-5" /></button></div></div></div><MobileMenu isOpen={mobileMenuOpen} onClose={() => setMobileMenuOpen(false)} tabs={adminTabs} activeTab={adminTab} setActiveTab={(t) => { setAdminTab(t); setSelectedCliente(null); }} user={user} onLogout={handleLogout} /><div className="p-4 max-w-7xl mx-auto"><ErrorBanner />{saveStatus && <div className="bg-emerald-500/20 text-emerald-300 rounded-xl px-4 py-2 mb-4 text-center text-sm">{saveStatus}</div>}<div className="hidden md:flex gap-2 mb-4 overflow-x-auto pb-2">{adminTabs.map(t => <button key={t.id} onClick={() => { setAdminTab(t.id); setSelectedCliente(null); }} className={`px-4 py-2 rounded-xl font-medium whitespace-nowrap text-sm ${adminTab === t.id ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-white'}`}>{t.icon} {t.label}</button>)}</div>{adminTab === 'dashboard' && <DashboardTab totals={totals} sales={sales} vendite={vendite} byStato={byStato} byMonth={byMonth} byAgente={byAgente} byZona={byZona} fmt={fmt} pipelineColors={pipelineColors} />}{adminTab === 'vendite' && <VenditeTab sales={filteredSales} loading={loading} filters={filters} setFilters={setFilters} updateSale={updateSale} deleteSale={deleteSale} loadSales={loadSales} exportToCSV={exportToCSV} fmt={fmt} selectedSales={selectedSales} toggleSelectSale={toggleSelectSale} selectAllSales={selectAllSales} deleteSelectedSales={deleteSelectedSales} />}{adminTab === 'pipeline' && <PipelineTab byStato={byStato} fmt={fmt} pipelineColors={pipelineColors} pipelineLabels={pipelineLabels} />}{adminTab === 'clienti' && (selectedCliente ? <ClienteDetail cliente={selectedCliente} sales={getClientSales(selectedCliente.id)} onBack={() => setSelectedCliente(null)} onEdit={() => { setEditingCliente(selectedCliente); setShowClienteModal(true); }} onDelete={() => deleteCliente(selectedCliente.id)} updateCliente={updateCliente} fmt={fmt} fmtDate={fmtDate} /> : <ClientiTab clienti={filteredClienti} loadClienti={loadClienti} createCliente={createCliente} deleteCliente={deleteCliente} showModal={showClienteModal} setShowModal={setShowClienteModal} editingCliente={editingCliente} setEditingCliente={setEditingCliente} selectedClienti={selectedClienti} toggleSelectCliente={toggleSelectCliente} deleteSelectedClienti={deleteSelectedClienti} onSelectCliente={setSelectedCliente} filters={clienteFilters} setFilters={setClienteFilters} showFilters={showFilters} setShowFilters={setShowFilters} uniqueAgenti={uniqueAgenti} exportToCSV={exportClientiToCSV} sales={sales} fmt={fmt} updateCliente={updateCliente} />)}{adminTab === 'utenti' && <UserManagement users={users} loadUsers={loadUsers} createUser={createUser} updateUser={updateUser} deleteUser={deleteUser} showUserModal={showUserModal} setShowUserModal={setShowUserModal} editingUser={editingUser} setEditingUser={setEditingUser} selectedUsers={selectedUsers} toggleSelectUser={toggleSelectUser} deleteSelectedUsers={deleteSelectedUsers} />}</div></div>;
```

}
return null;
}

// COMPONENTS
function LoginForm({ onLogin, loading }) { const [u, setU] = useState(â€™â€™); const [p, setP] = useState(â€™â€™); const [sp, setSp] = useState(false); return <form onSubmit={(e) => { e.preventDefault(); onLogin(u, p); }} className=â€œspace-y-4â€><div><label className="block text-slate-300 text-sm mb-2">Username</label><input type=â€œtextâ€ value={u} onChange={(e) => setU(e.target.value)} className=â€œw-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-whiteâ€ /></div><div><label className="block text-slate-300 text-sm mb-2">Password</label><div className="relative"><input type={sp ? â€˜textâ€™ : â€˜passwordâ€™} value={p} onChange={(e) => setP(e.target.value)} className=â€œw-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 pr-12 text-whiteâ€ /><button type=â€œbuttonâ€ onClick={() => setSp(!sp)} className=â€œabsolute right-3 top-1/2 -translate-y-1/2 text-slate-400â€>{sp ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}</button></div></div><button type=â€œsubmitâ€ disabled={loading || !u || !p} className=â€œw-full bg-amber-500 hover:bg-amber-600 disabled:bg-slate-600 text-slate-900 rounded-xl py-3 font-semiboldâ€>{loading ? â€˜â€¦â€™ : â€˜Accediâ€™}</button></form>; }

function PasswordModal({ currentPassword, onSave, onClose }) { const [op, setOp] = useState(â€™â€™); const [np, setNp] = useState(â€™â€™); const [cp, setCp] = useState(â€™â€™); const [e, setE] = useState(â€™â€™); const save = () => { if (op !== currentPassword) { setE(â€˜Password errataâ€™); return; } if (np.length < 6) { setE(â€˜Min 6 caratteriâ€™); return; } if (np !== cp) { setE(â€˜Non coincidonoâ€™); return; } onSave(np); }; return <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50"><div className="bg-slate-800 rounded-2xl p-6 max-w-sm w-full border border-slate-700"><h3 className="text-lg font-semibold text-white mb-4">Cambia Password</h3>{e && <div className="bg-red-500/20 text-red-300 rounded-lg px-3 py-2 mb-4 text-sm">{e}</div>}<div className="space-y-3"><input type=â€œpasswordâ€ placeholder=â€œAttualeâ€ value={op} onChange={(e) => setOp(e.target.value)} className=â€œw-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-whiteâ€ /><input type=â€œpasswordâ€ placeholder=â€œNuovaâ€ value={np} onChange={(e) => setNp(e.target.value)} className=â€œw-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-whiteâ€ /><input type=â€œpasswordâ€ placeholder=â€œConfermaâ€ value={cp} onChange={(e) => setCp(e.target.value)} className=â€œw-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-whiteâ€ /><div className="flex gap-3 pt-2"><button onClick={onClose} className="flex-1 bg-slate-700 text-white rounded-xl py-3">Annulla</button><button onClick={save} className="flex-1 bg-amber-500 text-slate-900 rounded-xl py-3 font-semibold">Salva</button></div></div></div></div>; }

function ConvertModal({ sale, onConvert, onCancel }) { const [v, setV] = useState(sale.valore || â€˜â€™); return <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50"><div className="bg-slate-800 rounded-2xl p-6 max-w-sm w-full border border-slate-700"><h3 className="text-lg font-semibold text-white mb-4">ğŸ‰ Registra Vendita</h3><div className="bg-slate-700/50 rounded-xl p-3 mb-4"><div className="text-white font-medium text-sm">{sale.progetto}</div><div className="text-slate-400 text-xs">{sale.developer}</div>{sale.cliente_nome && <div className="text-blue-400 text-xs mt-1">ğŸ‘¤ {sale.cliente_nome}</div>}</div><input type=â€œnumberâ€ placeholder=â€œValore (AED)â€ value={v} onChange={(e) => setV(e.target.value)} className=â€œw-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-white mb-4â€ autoFocus /><div className="flex gap-3"><button onClick={onCancel} className="flex-1 bg-slate-700 text-white rounded-xl py-3">Annulla</button><button onClick={() => v && onConvert(sale.id, parseFloat(v))} disabled={!v} className=â€œflex-1 bg-emerald-500 disabled:bg-slate-600 text-white rounded-xl py-3 font-semiboldâ€>Conferma</button></div></div></div>; }

function LeadFormClean({ type, userName, clienti, onSubmit }) { const [selectedClient, setSelectedClient] = useState(null); const [showNew, setShowNew] = useState(false); const [f, setF] = useState({ data: new Date().toISOString().split(â€˜Tâ€™)[0], developer: â€˜â€™, progetto: â€˜â€™, zona: â€˜â€™, valore: â€˜â€™, stato: â€˜leadâ€™, cliente_nome: â€˜â€™, cliente_cognome: â€˜â€™, cliente_email: â€˜â€™, cliente_telefono: â€˜â€™, cliente_whatsapp: â€˜â€™, cliente_nazionalita: â€˜â€™, cliente_budget_min: â€˜â€™, cliente_budget_max: â€˜â€™, cliente_note: â€˜â€™ }); const myClienti = clienti.filter(c => c.created_by === userName || c.agente_riferimento === userName); const sub = (e) => { e?.preventDefault(); if (!selectedClient && !f.cliente_nome) { alert(â€˜Seleziona o crea un clienteâ€™); return; } onSubmit({ â€¦f, cliente_id: selectedClient?.id, cliente_nome: selectedClient?.nome || f.cliente_nome, cliente_cognome: selectedClient?.cognome || f.cliente_cognome, developer: f.developer || â€˜TBDâ€™, progetto: f.progetto || â€˜TBDâ€™, zona: f.zona || â€˜TBDâ€™, valore: f.valore ? parseFloat(f.valore) : 0, agente: type === â€˜agenteâ€™ ? userName : null, segnalatore: type === â€˜segnalatoreâ€™ ? userName : null }); }; const inp = â€œw-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white text-smâ€; return <form onSubmit={sub}><div className="space-y-4"><div className="bg-slate-800/50 rounded-xl p-4"><h4 className="text-white font-medium mb-3 flex items-center gap-2"><User className="w-4 h-4" /> Cliente</h4><ClientSearch clienti={myClienti} selectedClient={selectedClient} onSelect={(c) => { setSelectedClient(c); setShowNew(false); }} onCreateNew={() => { setSelectedClient(null); setShowNew(true); }} />{showNew && !selectedClient && <div className="mt-4 pt-4 border-t border-slate-700 space-y-3"><div className="grid grid-cols-2 gap-3"><input type=â€œtextâ€ placeholder=â€œNome *â€ value={f.cliente_nome} onChange={(e) => setF({ â€¦f, cliente_nome: e.target.value })} className={inp} /><input type=â€œtextâ€ placeholder=â€œCognomeâ€ value={f.cliente_cognome} onChange={(e) => setF({ â€¦f, cliente_cognome: e.target.value })} className={inp} /><input type=â€œtelâ€ placeholder=â€œTelefonoâ€ value={f.cliente_telefono} onChange={(e) => setF({ â€¦f, cliente_telefono: e.target.value })} className={inp} /><input type=â€œemailâ€ placeholder=â€œEmailâ€ value={f.cliente_email} onChange={(e) => setF({ â€¦f, cliente_email: e.target.value })} className={inp} /><input type=â€œtelâ€ placeholder=â€œWhatsAppâ€ value={f.cliente_whatsapp} onChange={(e) => setF({ â€¦f, cliente_whatsapp: e.target.value })} className={inp} /><input type=â€œtextâ€ placeholder=â€œNazionalitÃ â€ value={f.cliente_nazionalita} onChange={(e) => setF({ â€¦f, cliente_nazionalita: e.target.value })} className={inp} /><input type=â€œnumberâ€ placeholder=â€œBudget Minâ€ value={f.cliente_budget_min} onChange={(e) => setF({ â€¦f, cliente_budget_min: e.target.value })} className={inp} /><input type=â€œnumberâ€ placeholder=â€œBudget Maxâ€ value={f.cliente_budget_max} onChange={(e) => setF({ â€¦f, cliente_budget_max: e.target.value })} className={inp} /></div><textarea placeholder=â€œNoteâ€¦â€ value={f.cliente_note} onChange={(e) => setF({ â€¦f, cliente_note: e.target.value })} className={`${inp} h-16`} /></div>}</div><div className="bg-slate-800/50 rounded-xl p-4"><h4 className="text-white font-medium mb-3">ğŸ  Interesse</h4><div className="grid grid-cols-2 gap-3"><SelectWithOther value={f.developer} onChange={(v) => setF({ â€¦f, developer: v })} options={developers} placeholder=â€œDeveloperâ€ className={inp} /><SelectWithOther value={f.zona} onChange={(v) => setF({ â€¦f, zona: v })} options={zones} placeholder=â€œZonaâ€ className={inp} /><input type=â€œtextâ€ placeholder=â€œProgettoâ€ value={f.progetto} onChange={(e) => setF({ â€¦f, progetto: e.target.value })} className={inp} /><input type=â€œnumberâ€ placeholder=â€œValoreâ€ value={f.valore} onChange={(e) => setF({ â€¦f, valore: e.target.value })} className={inp} /></div></div><div className="bg-slate-800/50 rounded-xl p-4"><h4 className="text-white font-medium mb-3">Stato</h4><div className="flex flex-wrap gap-2">{pipelineStati.slice(0, 4).map(st => <button key={st} type=â€œbuttonâ€ onClick={() => setF({ â€¦f, stato: st })} className={`px-4 py-2 rounded-lg text-sm ${f.stato === st ? `${pipelineColors[st]} text-white` : 'bg-slate-700 text-slate-400'}`}>{st}</button>)}</div></div></div><button type="submit" id="submitBtn" className="hidden">Submit</button></form>; }

function SaleFormClean({ type, userName, clienti, onSubmit }) { const [selectedClient, setSelectedClient] = useState(null); const [showNew, setShowNew] = useState(false); const [f, setF] = useState({ data: new Date().toISOString().split(â€˜Tâ€™)[0], developer: â€˜â€™, progetto: â€˜â€™, zona: â€˜â€™, valore: â€˜â€™, nuovo_cliente_nome: â€˜â€™, nuovo_cliente_cognome: â€˜â€™, nuovo_cliente_telefono: â€˜â€™, nuovo_cliente_email: â€˜â€™ }); const myClienti = clienti.filter(c => c.created_by === userName || c.agente_riferimento === userName); const sub = (e) => { e?.preventDefault(); if (!selectedClient && !f.nuovo_cliente_nome) { alert(â€˜Seleziona o inserisci il clienteâ€™); return; } if (!f.developer || !f.progetto || !f.zona || !f.valore) { alert(â€˜Compila tutti i campiâ€™); return; } onSubmit({ data: f.data, developer: f.developer, progetto: f.progetto, zona: f.zona, valore: parseFloat(f.valore), agente: type === â€˜agenteâ€™ ? userName : null, segnalatore: type === â€˜segnalatoreâ€™ ? userName : null, cliente_id: selectedClient?.id, cliente_nome: selectedClient?.nome || f.nuovo_cliente_nome, nuovo_cliente_nome: f.nuovo_cliente_nome, nuovo_cliente_cognome: f.nuovo_cliente_cognome, nuovo_cliente_telefono: f.nuovo_cliente_telefono, nuovo_cliente_email: f.nuovo_cliente_email }); }; const inp = â€œw-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white text-smâ€; return <form onSubmit={sub}><div className="space-y-4"><div className="bg-slate-800/50 rounded-xl p-4"><h4 className="text-white font-medium mb-3 flex items-center gap-2"><User className="w-4 h-4" /> Cliente</h4><ClientSearch clienti={myClienti} selectedClient={selectedClient} onSelect={(c) => { setSelectedClient(c); setShowNew(false); }} onCreateNew={() => { setSelectedClient(null); setShowNew(true); }} />{showNew && !selectedClient && <div className="mt-4 pt-4 border-t border-slate-700"><div className="grid grid-cols-2 gap-3"><input type=â€œtextâ€ placeholder=â€œNome *â€ value={f.nuovo_cliente_nome} onChange={(e) => setF({ â€¦f, nuovo_cliente_nome: e.target.value })} className={inp} /><input type=â€œtextâ€ placeholder=â€œCognomeâ€ value={f.nuovo_cliente_cognome} onChange={(e) => setF({ â€¦f, nuovo_cliente_cognome: e.target.value })} className={inp} /><input type=â€œtelâ€ placeholder=â€œTelefonoâ€ value={f.nuovo_cliente_telefono} onChange={(e) => setF({ â€¦f, nuovo_cliente_telefono: e.target.value })} className={inp} /><input type=â€œemailâ€ placeholder=â€œEmailâ€ value={f.nuovo_cliente_email} onChange={(e) => setF({ â€¦f, nuovo_cliente_email: e.target.value })} className={inp} /></div></div>}</div><div className="bg-slate-800/50 rounded-xl p-4"><h4 className="text-white font-medium mb-3">ğŸ’° Vendita</h4><div className="space-y-3"><input type=â€œdateâ€ value={f.data} onChange={(e) => setF({ â€¦f, data: e.target.value })} className={inp} /><SelectWithOther value={f.developer} onChange={(v) => setF({ â€¦f, developer: v })} options={developers} placeholder=â€œDeveloper *â€ className={inp} /><input type=â€œtextâ€ placeholder=â€œProgetto *â€ value={f.progetto} onChange={(e) => setF({ â€¦f, progetto: e.target.value })} className={inp} /><SelectWithOther value={f.zona} onChange={(v) => setF({ â€¦f, zona: v })} options={zones} placeholder=â€œZona *â€ className={inp} /><input type=â€œnumberâ€ placeholder=â€œValore (AED) *â€ value={f.valore} onChange={(e) => setF({ â€¦f, valore: e.target.value })} className={inp} /></div></div></div><button type="submit" id="submitBtn" className="hidden">Submit</button></form>; }

function DashboardTab({ totals, sales, vendite, byStato, byMonth, byAgente, byZona, fmt, pipelineColors }) { const sm = Object.entries(byMonth).sort((a, b) => a[0].localeCompare(b[0])).slice(-6); const maxM = Math.max(â€¦sm.map(([, v]) => v)) || 1; const sa = Object.entries(byAgente).sort((a, b) => b[1] - a[1]).slice(0, 5); const sz = Object.entries(byZona).sort((a, b) => b[1] - a[1]).slice(0, 5); const avg = vendite.length > 0 ? totals.valore / vendite.length : 0; const conv = sales.length > 0 ? (vendite.length / sales.length * 100).toFixed(1) : 0; return <div className="space-y-4"><div className="grid grid-cols-2 md:grid-cols-4 gap-2"><div className="bg-gradient-to-br from-blue-500/20 to-blue-600/30 border border-blue-500/30 rounded-xl p-3"><div className="flex items-center gap-2 text-blue-300 text-xs mb-1"><Target className="w-3 h-3" />Lead</div><div className="text-2xl font-bold text-white">{sales.length}</div></div><div className="bg-gradient-to-br from-emerald-500/20 to-emerald-600/30 border border-emerald-500/30 rounded-xl p-3"><div className="flex items-center gap-2 text-emerald-300 text-xs mb-1"><TrendingUp className="w-3 h-3" />Vendite</div><div className="text-2xl font-bold text-white">{vendite.length}</div><div className="text-emerald-400 text-xs">{conv}% conv.</div></div><div className="bg-gradient-to-br from-amber-500/20 to-amber-600/30 border border-amber-500/30 rounded-xl p-3"><div className="flex items-center gap-2 text-amber-300 text-xs mb-1"><DollarSign className="w-3 h-3" />Volume</div><div className="text-xl font-bold text-white">{fmt(totals.valore)}</div></div><div className="bg-gradient-to-br from-purple-500/20 to-purple-600/30 border border-purple-500/30 rounded-xl p-3"><div className="flex items-center gap-2 text-purple-300 text-xs mb-1"><UserCheck className="w-3 h-3" />Netto KP</div><div className="text-xl font-bold text-white">{fmt(totals.netto)}</div></div></div><div className="grid grid-cols-3 md:grid-cols-6 gap-2"><div className="bg-slate-800 border border-slate-700 rounded-xl p-2 text-center"><div className="text-slate-400 text-xs">Media</div><div className="text-sm font-bold text-amber-400">{fmt(avg)}</div></div><div className="bg-slate-800 border border-slate-700 rounded-xl p-2 text-center"><div className="text-slate-400 text-xs">Comm</div><div className="text-sm font-bold text-emerald-400">{fmt(totals.comm)}</div></div><div className="bg-slate-800 border border-slate-700 rounded-xl p-2 text-center"><div className="text-slate-400 text-xs">Ag 70%</div><div className="text-sm font-bold text-blue-400">{fmt(totals.ag)}</div></div><div className="bg-slate-800 border border-slate-700 rounded-xl p-2 text-center"><div className="text-slate-400 text-xs">Seg 30%</div><div className="text-sm font-bold text-cyan-400">{fmt(totals.sg)}</div></div><div className="bg-green-900/30 border border-green-700/50 rounded-xl p-2 text-center"><div className="text-green-300 text-xs">Pell</div><div className="text-sm font-bold text-green-400">{fmt(totals.pell)}</div></div><div className="bg-orange-900/30 border border-orange-700/50 rounded-xl p-2 text-center"><div className="text-orange-300 text-xs">Giov</div><div className="text-sm font-bold text-orange-400">{fmt(totals.giov)}</div></div></div><div className="bg-slate-800 border border-slate-700 rounded-xl p-4"><h3 className="text-white font-semibold mb-3">Pipeline</h3><div className="flex gap-2 overflow-x-auto pb-2">{Object.entries(byStato).map(([st, items]) => <div key={st} className="flex-1 min-w-[60px]"><div className={`${pipelineColors[st]} rounded-lg p-2 text-center text-white`}><div className="text-xl font-bold">{items.length}</div><div className="text-xs opacity-80">{st}</div></div></div>)}</div></div><div className="grid md:grid-cols-3 gap-4"><div className="bg-slate-800 border border-slate-700 rounded-xl p-4"><h3 className="text-white font-semibold mb-3 flex items-center gap-2"><TrendingUp className="w-4 h-4 text-amber-400" />Andamento</h3><div className="space-y-2">{sm.map(([m, v]) => <div key={m} className="flex items-center gap-2"><div className="text-slate-400 text-xs w-14">{m}</div><div className="flex-1 bg-slate-700 rounded-full h-3"><div className=â€œbg-amber-500 h-full rounded-fullâ€ style={{ width: `${(v / maxM) * 100}%` }} /></div><div className="text-white text-xs w-16 text-right">{fmt(v)}</div></div>)}</div></div><div className="bg-slate-800 border border-slate-700 rounded-xl p-4"><h3 className="text-white font-semibold mb-3 flex items-center gap-2"><Award className="w-4 h-4 text-blue-400" />Top Agenti</h3><div className="space-y-2">{sa.length === 0 ? <div className="text-slate-500 text-sm">-</div> : sa.map(([a, v], i) => <div key={a} className="flex items-center gap-2"><div className={`w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold ${i === 0 ? 'bg-amber-500 text-slate-900' : 'bg-slate-600 text-white'}`}>{i + 1}</div><div className="text-white text-sm flex-1 truncate">{a}</div><div className="text-amber-400 text-xs">{fmt(v)}</div></div>)}</div></div><div className="bg-slate-800 border border-slate-700 rounded-xl p-4"><h3 className="text-white font-semibold mb-3 flex items-center gap-2"><MapPin className="w-4 h-4 text-emerald-400" />Top Zone</h3><div className="space-y-2">{sz.length === 0 ? <div className="text-slate-500 text-sm">-</div> : sz.map(([z, v], i) => <div key={z} className="flex items-center gap-2"><div className="text-slate-400 text-xs w-4">{i + 1}</div><div className="text-white text-sm flex-1 truncate">{z}</div><div className="text-emerald-400 text-xs">{fmt(v)}</div></div>)}</div></div></div></div>; }

function VenditeTab({ sales, loading, filters, setFilters, updateSale, deleteSale, loadSales, exportToCSV, fmt, selectedSales, toggleSelectSale, selectAllSales, deleteSelectedSales }) { return <><div className="bg-slate-800 border border-slate-700 rounded-xl p-3 mb-4"><div className="flex flex-wrap gap-2 items-center"><button onClick={loadSales} className="bg-slate-700 text-white rounded-lg px-3 py-2"><RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} /></button><button onClick={exportToCSV} className="bg-emerald-500 text-white rounded-lg px-3 py-2"><Download className="w-4 h-4" /></button>{selectedSales.length > 0 && <button onClick={deleteSelectedSales} className="bg-red-500 text-white rounded-lg px-3 py-2 flex items-center gap-1 text-sm"><Trash2 className="w-4 h-4" />{selectedSales.length}</button>}<div className="flex-1" /><div className="relative"><Search className="w-4 h-4 absolute left-2 top-1/2 -translate-y-1/2 text-slate-400" /><input type=â€œtextâ€ placeholder=â€œCercaâ€¦â€ value={filters.search} onChange={(e) => setFilters({ â€¦filters, search: e.target.value })} className=â€œbg-slate-700 border border-slate-600 rounded-lg pl-8 pr-3 py-2 text-white text-sm w-28â€ /></div><select value={filters.stato} onChange={(e) => setFilters({ â€¦filters, stato: e.target.value })} className=â€œbg-slate-700 border border-slate-600 rounded-lg px-2 py-2 text-white text-smâ€><option value="">Stato</option>{pipelineStati.map(s => <option key={s} value={s}>{s}</option>)}</select></div></div><div className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-sm"><thead><tr className="bg-slate-700/50 text-left"><th className="px-2 py-2"><button onClick={selectAllSales}>{selectedSales.length === sales.length && sales.length > 0 ? <CheckSquare className="w-4 h-4 text-amber-400" /> : <Square className="w-4 h-4 text-slate-400" />}</button></th><th className="text-slate-300 px-2 py-2 text-xs">Data</th><th className="text-slate-300 px-2 py-2 text-xs">Progetto</th><th className="text-slate-300 px-2 py-2 text-xs">Cliente</th><th className="text-slate-300 px-2 py-2 text-xs">Agente</th><th className="text-slate-300 px-2 py-2 text-right text-xs">Valore</th><th className="text-slate-300 px-2 py-2 text-center text-xs">%</th><th className="text-slate-300 px-2 py-2 text-center text-xs">Stato</th><th className="text-slate-300 px-2 py-2 text-center text-xs">Ref</th><th className="text-slate-300 px-2 py-2 text-center text-xs">ğŸ’°</th><th className="text-slate-300 px-2 py-2 text-center text-xs">ğŸ—‘ï¸</th></tr></thead><tbody>{sales.map(s => <tr key={s.id} className={`border-t border-slate-700 hover:bg-slate-700/30 ${selectedSales.includes(s.id) ? 'bg-amber-500/10' : ''}`}><td className="px-2 py-2"><button onClick={() => toggleSelectSale(s.id)}>{selectedSales.includes(s.id) ? <CheckSquare className="w-4 h-4 text-amber-400" /> : <Square className="w-4 h-4 text-slate-400" />}</button></td><td className="px-2 py-2 text-white text-xs">{s.data?.substring(5,10)}</td><td className="px-2 py-2 text-white text-xs truncate max-w-[80px]">{s.progetto}</td><td className="px-2 py-2 text-blue-400 text-xs truncate max-w-[60px]">{s.cliente_nome || â€˜-â€™}</td><td className="px-2 py-2 text-slate-400 text-xs truncate max-w-[60px]">{s.agente || â€˜-â€™}</td><td className="px-2 py-2 text-amber-400 text-right text-xs">{s.valore > 0 ? fmt(s.valore) : â€˜-â€™}</td><td className="px-2 py-2 text-center"><select value={s.commission_pct || 5} onChange={(e) => updateSale(s.id, { commission_pct: parseInt(e.target.value) })} className=â€œbg-slate-700 rounded px-1 py-0.5 text-white text-xs w-12â€>{commissions.map(c => <option key={c} value={c}>{c}%</option>)}</select></td><td className="px-2 py-2 text-center"><select value={s.stato || â€˜leadâ€™} onChange={(e) => updateSale(s.id, { stato: e.target.value })} className={`${pipelineColors[s.stato || 'lead']} rounded px-1 py-0.5 text-white text-xs w-16`}>{pipelineStati.map(st => <option key={st} value={st} className="bg-slate-800">{st}</option>)}</select></td><td className="px-2 py-2 text-center"><select value={s.referente || â€˜â€™} onChange={(e) => updateSale(s.id, { referente: e.target.value || null })} className={`bg-slate-700 rounded px-1 py-0.5 text-xs w-10 ${s.referente ? 'text-emerald-400' : 'text-red-400'}`}><option value="">-</option><option value="Pellegrino">P</option><option value="Giovanni">G</option></select></td><td className="px-2 py-2 text-center"><button onClick={() => updateSale(s.id, { pagato: !s.pagato })} className={`px-1.5 py-0.5 rounded text-xs ${s.pagato ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>{s.pagato ? â€˜âœ“â€™ : â€˜âœ—â€™}</button></td><td className="px-2 py-2 text-center"><button onClick={() => deleteSale(s.id)} className=â€œtext-red-400â€><Trash2 className="w-3 h-3" /></button></td></tr>)}</tbody></table></div></div></>; }

function PipelineTab({ byStato, fmt, pipelineColors, pipelineLabels }) { return <div className="grid grid-cols-2 md:grid-cols-5 gap-2">{pipelineStati.map(st => <div key={st} className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden"><div className={`${pipelineColors[st]} px-2 py-1.5 text-white text-xs flex justify-between`}><span>{pipelineLabels[st]}</span><span className="bg-white/20 px-1.5 rounded">{byStato[st]?.length || 0}</span></div><div className="p-2 space-y-2 max-h-[50vh] overflow-y-auto">{byStato[st]?.map(s => <div key={s.id} className="bg-slate-700/50 rounded-lg p-2"><div className="text-white text-xs truncate">{s.progetto}</div><div className="text-blue-400 text-xs truncate">{s.cliente_nome || â€˜-â€™}</div><div className="text-slate-400 text-xs truncate">{s.agente || s.segnalatore || â€˜-â€™}</div>{s.valore > 0 && <div className="text-amber-400 text-xs mt-1">{fmt(s.valore)}</div>}</div>)}{!byStato[st]?.length && <div className="text-slate-500 text-xs text-center py-3">-</div>}</div></div>)}</div>; }

function ClientiTab({ clienti, loadClienti, createCliente, updateCliente, deleteCliente, showModal, setShowModal, editingCliente, setEditingCliente, selectedClienti, toggleSelectCliente, deleteSelectedClienti, onSelectCliente, filters, setFilters, showFilters, setShowFilters, uniqueAgenti, exportToCSV, sales, fmt }) { const activeFilters = [filters.stato, filters.agente, filters.budgetMin, filters.budgetMax].filter(Boolean).length; const getClientValue = (id) => sales.filter(s => s.cliente_id === id && (s.stato === â€˜vendutoâ€™ || s.stato === â€˜incassatoâ€™)).reduce((sum, s) => sum + Number(s.valore || 0), 0); return <><div className="flex flex-wrap gap-2 items-center mb-4"><button onClick={() => { setEditingCliente(null); setShowModal(true); }} className=â€œbg-amber-500 text-slate-900 rounded-lg px-3 py-2 flex items-center gap-1 text-sm font-semiboldâ€><UserPlus className="w-4 h-4" />Nuovo</button><button onClick={loadClienti} className="bg-slate-700 text-white rounded-lg px-3 py-2"><RefreshCw className="w-4 h-4" /></button><button onClick={exportToCSV} className="bg-emerald-500 text-white rounded-lg px-3 py-2"><Download className="w-4 h-4" /></button><button onClick={() => setShowFilters(!showFilters)} className={`rounded-lg px-3 py-2 flex items-center gap-1 text-sm ${activeFilters > 0 ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-white'}`}><Filter className="w-4 h-4" />{activeFilters > 0 && <span className="bg-slate-900 text-amber-500 px-1.5 rounded text-xs">{activeFilters}</span>}</button>{selectedClienti.length > 0 && <button onClick={deleteSelectedClienti} className="bg-red-500 text-white rounded-lg px-3 py-2 flex items-center gap-1 text-sm"><Trash2 className="w-4 h-4" />{selectedClienti.length}</button>}<div className="flex-1" /><div className="text-slate-400 text-sm">{clienti.length} clienti</div></div>{showFilters && <div className="bg-slate-800 border border-slate-700 rounded-xl p-4 mb-4"><div className="grid grid-cols-2 md:grid-cols-5 gap-3"><div className="col-span-2 md:col-span-1 relative"><Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" /><input type=â€œtextâ€ placeholder=â€œCercaâ€¦â€ value={filters.search} onChange={(e) => setFilters({ â€¦filters, search: e.target.value })} className=â€œw-full bg-slate-700 border border-slate-600 rounded-lg pl-9 pr-3 py-2 text-white text-smâ€ /></div><select value={filters.stato} onChange={(e) => setFilters({ â€¦filters, stato: e.target.value })} className=â€œbg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white text-smâ€><option value="">Tutti stati</option>{clienteStati.map(s => <option key={s} value={s}>{s}</option>)}</select><select value={filters.agente} onChange={(e) => setFilters({ â€¦filters, agente: e.target.value })} className=â€œbg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white text-smâ€><option value="">Tutti agenti</option>{uniqueAgenti.map(a => <option key={a} value={a}>{a}</option>)}</select><input type=â€œnumberâ€ placeholder=â€œBudget minâ€ value={filters.budgetMin} onChange={(e) => setFilters({ â€¦filters, budgetMin: e.target.value })} className=â€œbg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white text-smâ€ /><input type=â€œnumberâ€ placeholder=â€œBudget maxâ€ value={filters.budgetMax} onChange={(e) => setFilters({ â€¦filters, budgetMax: e.target.value })} className=â€œbg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white text-smâ€ /></div>{activeFilters > 0 && <button onClick={() => setFilters({ search: â€˜â€™, stato: â€˜â€™, budgetMin: â€˜â€™, budgetMax: â€˜â€™, agente: â€˜â€™ })} className=â€œmt-3 text-amber-400 text-sm flex items-center gap-1â€><X className="w-4 h-4" /> Rimuovi filtri</button>}</div>}<div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">{clienti.map(c => { const cv = getClientValue(c.id); const cs = sales.filter(s => s.cliente_id === c.id).length; return <div key={c.id} onClick={() => onSelectCliente(c)} className={`bg-slate-800 border rounded-xl p-4 cursor-pointer hover:border-amber-500/50 ${selectedClienti.includes(c.id) ? 'border-amber-500' : 'border-slate-700'}`}><div className="flex items-start gap-3"><button onClick={(e) => { e.stopPropagation(); toggleSelectCliente(c.id); }}>{selectedClienti.includes(c.id) ? <CheckSquare className="w-4 h-4 text-amber-400" /> : <Square className="w-4 h-4 text-slate-500" />}</button><div className="flex-1"><div className="flex justify-between items-start mb-2"><div><div className="text-white font-medium">{c.nome} {c.cognome}</div>{c.nazionalita && <div className="text-slate-400 text-xs">{c.nazionalita}</div>}</div><span className={`px-2 py-0.5 rounded text-xs text-white ${clienteStatiColors[c.stato] || 'bg-slate-600'}`}>{c.stato}</span></div><div className="space-y-1 mb-3">{c.telefono && <div className="flex items-center gap-2"><Phone className="w-3 h-3 text-slate-400" /><span className="text-slate-300 text-sm">{c.telefono}</span><a href={getWhatsAppLink(c.whatsapp || c.telefono)} target=â€_blankâ€ rel=â€œnoopener noreferrerâ€ onClick={(e) => e.stopPropagation()} className=â€œtext-emerald-400â€><MessageCircle className="w-4 h-4" /></a></div>}{c.email && <div className="flex items-center gap-2 text-slate-400 text-xs"><Mail className="w-3 h-3" />{c.email}</div>}</div><div className="flex items-center justify-between pt-2 border-t border-slate-700"><div className="text-xs">{c.budget_max ? <span className="text-amber-400">ğŸ’° {fmt(c.budget_max)}</span> : <span className="text-slate-500">N/A</span>}</div><div className="flex items-center gap-2">{cs > 0 && <span className="text-blue-400 text-xs">{cs} lead</span>}{cv > 0 && <span className="text-emerald-400 text-xs">{fmt(cv)}</span>}</div></div></div></div></div>; })}</div>{clienti.length === 0 && <div className="bg-slate-800 border border-slate-700 rounded-xl p-8 text-center text-slate-500">Nessun cliente</div>}{showModal && <ClienteModal cliente={editingCliente} onClose={() => { setShowModal(false); setEditingCliente(null); }} onSave={editingCliente ? (d) => updateCliente(editingCliente.id, d) : createCliente} />}</>; }

function ClienteDetail({ cliente, sales, onBack, onEdit, onDelete, updateCliente, fmt, fmtDate }) { const [tab, setTab] = useState(â€˜infoâ€™); const totalValue = sales.filter(s => s.stato === â€˜vendutoâ€™ || s.stato === â€˜incassatoâ€™).reduce((sum, s) => sum + Number(s.valore || 0), 0); const leadCount = sales.filter(s => s.stato === â€˜leadâ€™ || s.stato === â€˜trattativaâ€™).length; const venditeCount = sales.filter(s => s.stato === â€˜vendutoâ€™ || s.stato === â€˜incassatoâ€™).length; return <div><div className="flex items-center gap-4 mb-6"><button onClick={onBack} className="bg-slate-700 text-white rounded-xl p-2"><ChevronLeft className="w-5 h-5" /></button><div className="flex-1"><h1 className="text-xl font-bold text-white">{cliente.nome} {cliente.cognome}</h1><div className="flex items-center gap-2 mt-1"><span className={`px-2 py-0.5 rounded text-xs text-white ${clienteStatiColors[cliente.stato] || 'bg-slate-600'}`}>{cliente.stato}</span>{cliente.nazionalita && <span className="text-slate-400 text-sm">{cliente.nazionalita}</span>}</div></div><button onClick={onEdit} className="bg-blue-500/20 text-blue-400 rounded-xl p-2"><Edit2 className="w-5 h-5" /></button><button onClick={onDelete} className="bg-red-500/20 text-red-400 rounded-xl p-2"><Trash2 className="w-5 h-5" /></button></div><div className="grid grid-cols-4 gap-2 mb-6"><div className="bg-slate-800 border border-slate-700 rounded-xl p-3 text-center"><div className="text-slate-400 text-xs">Lead</div><div className="text-xl font-bold text-blue-400">{leadCount}</div></div><div className="bg-slate-800 border border-slate-700 rounded-xl p-3 text-center"><div className="text-slate-400 text-xs">Vendite</div><div className="text-xl font-bold text-emerald-400">{venditeCount}</div></div><div className="bg-slate-800 border border-slate-700 rounded-xl p-3 text-center"><div className="text-slate-400 text-xs">Valore</div><div className="text-lg font-bold text-amber-400">{fmt(totalValue)}</div></div><div className="bg-slate-800 border border-slate-700 rounded-xl p-3 text-center"><div className="text-slate-400 text-xs">Budget</div><div className="text-sm font-bold text-purple-400">{cliente.budget_max ? fmt(cliente.budget_max) : â€˜N/Aâ€™}</div></div></div><div className="flex gap-2 mb-6">{cliente.telefono && <a href={`tel:${cliente.telefono}`} className=â€œflex-1 bg-slate-700 text-white rounded-xl py-3 flex items-center justify-center gap-2 text-smâ€><Phone className="w-4 h-4" /> Chiama</a>}{(cliente.whatsapp || cliente.telefono) && <a href={getWhatsAppLink(cliente.whatsapp || cliente.telefono, `Ciao ${cliente.nome}, `)} target=â€_blankâ€ rel=â€œnoopener noreferrerâ€ className=â€œflex-1 bg-emerald-500 text-white rounded-xl py-3 flex items-center justify-center gap-2 text-smâ€><MessageCircle className="w-4 h-4" /> WhatsApp</a>}{cliente.email && <a href={`mailto:${cliente.email}`} className=â€œflex-1 bg-blue-500 text-white rounded-xl py-3 flex items-center justify-center gap-2 text-smâ€><Mail className="w-4 h-4" /> Email</a>}</div><div className="flex gap-2 mb-4"><button onClick={() => setTab(â€˜infoâ€™)} className={`px-4 py-2 rounded-xl text-sm font-medium ${tab === 'info' ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-white'}`}>Info</button><button onClick={() => setTab(â€˜salesâ€™)} className={`px-4 py-2 rounded-xl text-sm font-medium ${tab === 'sales' ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-white'}`}>Lead/Vendite ({sales.length})</button></div>{tab === â€˜infoâ€™ && <div className="bg-slate-800 border border-slate-700 rounded-xl p-4 space-y-4"><div className="grid grid-cols-2 gap-4"><div><div className="text-slate-400 text-xs mb-1">Telefono</div><div className="text-white">{cliente.telefono || â€˜-â€™}</div></div><div><div className="text-slate-400 text-xs mb-1">WhatsApp</div><div className="text-white">{cliente.whatsapp || cliente.telefono || â€˜-â€™}</div></div><div><div className="text-slate-400 text-xs mb-1">Email</div><div className="text-white truncate">{cliente.email || â€˜-â€™}</div></div><div><div className="text-slate-400 text-xs mb-1">NazionalitÃ </div><div className="text-white">{cliente.nazionalita || â€˜-â€™}</div></div><div><div className="text-slate-400 text-xs mb-1">Budget Min</div><div className="text-amber-400">{cliente.budget_min ? fmt(cliente.budget_min) : â€˜-â€™}</div></div><div><div className="text-slate-400 text-xs mb-1">Budget Max</div><div className="text-amber-400">{cliente.budget_max ? fmt(cliente.budget_max) : â€˜-â€™}</div></div><div><div className="text-slate-400 text-xs mb-1">Agente</div><div className="text-white">{cliente.agente_riferimento || â€˜-â€™}</div></div><div><div className="text-slate-400 text-xs mb-1">Fonte</div><div className="text-white">{cliente.fonte || â€˜-â€™}</div></div><div><div className="text-slate-400 text-xs mb-1">Creato</div><div className="text-white">{fmtDate(cliente.created_at)}</div></div><div><div className="text-slate-400 text-xs mb-1">Da</div><div className="text-white">{cliente.created_by || â€˜-â€™}</div></div></div>{cliente.note && <div className="pt-4 border-t border-slate-700"><div className="text-slate-400 text-xs mb-1">Note</div><div className="text-white text-sm whitespace-pre-wrap">{cliente.note}</div></div>}<div className="pt-4 border-t border-slate-700"><div className="text-slate-400 text-xs mb-2">Cambia stato</div><div className="flex flex-wrap gap-2">{clienteStati.map(s => <button key={s} onClick={() => updateCliente(cliente.id, { stato: s })} className={`px-3 py-1.5 rounded-lg text-xs font-medium ${cliente.stato === s ? `${clienteStatiColors[s]} text-white` : 'bg-slate-700 text-slate-400'}`}>{s}</button>)}</div></div></div>}{tab === â€˜salesâ€™ && <div className="space-y-3">{sales.length === 0 ? <div className="bg-slate-800 border border-slate-700 rounded-xl p-8 text-center text-slate-500">Nessun lead</div> : sales.map(s => <div key={s.id} className="bg-slate-800 border border-slate-700 rounded-xl p-4"><div className="flex justify-between items-start mb-2"><div><div className="flex items-center gap-2"><span className="text-white font-medium">{s.progetto}</span><span className={`px-2 py-0.5 rounded text-xs text-white ${pipelineColors[s.stato || 'lead']}`}>{s.stato}</span></div><div className="text-slate-400 text-sm">{s.developer} â€¢ {s.zona}</div></div><div className="text-right"><div className="text-amber-400 font-semibold">{s.valore > 0 ? fmt(s.valore) : â€˜TBDâ€™}</div><div className="text-slate-500 text-xs">{fmtDate(s.data)}</div></div></div><div className="flex items-center gap-4 text-xs text-slate-400 pt-2 border-t border-slate-700">{s.agente && <span>Agente: {s.agente}</span>}{s.segnalatore && <span>Segnalatore: {s.segnalatore}</span>}{s.pagato && <span className="text-emerald-400">âœ“ Pagato</span>}</div></div>)}</div>}</div>; }

function ClienteModal({ cliente, onClose, onSave }) { const [f, setF] = useState(cliente || { nome: â€˜â€™, cognome: â€˜â€™, email: â€˜â€™, telefono: â€˜â€™, whatsapp: â€˜â€™, nazionalita: â€˜â€™, budget_min: â€˜â€™, budget_max: â€˜â€™, stato: â€˜nuovoâ€™, fonte: â€˜â€™, note: â€˜â€™ }); const save = async () => { if (!f.nome) { alert(â€˜Nome obbligatorioâ€™); return; } await onSave(f); }; const inp = â€œw-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-white text-smâ€; return <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50"><div className="bg-slate-800 rounded-2xl p-6 max-w-md w-full border border-slate-700 max-h-[90vh] overflow-y-auto"><h3 className="text-lg font-semibold text-white mb-4">{cliente ? â€˜Modificaâ€™ : â€˜Nuovoâ€™} Cliente</h3><div className="space-y-3"><div className="grid grid-cols-2 gap-3"><input type=â€œtextâ€ placeholder=â€œNome *â€ value={f.nome} onChange={(e) => setF({ â€¦f, nome: e.target.value })} className={inp} /><input type=â€œtextâ€ placeholder=â€œCognomeâ€ value={f.cognome || â€˜â€™} onChange={(e) => setF({ â€¦f, cognome: e.target.value })} className={inp} /></div><div className="grid grid-cols-2 gap-3"><input type=â€œtelâ€ placeholder=â€œTelefonoâ€ value={f.telefono || â€˜â€™} onChange={(e) => setF({ â€¦f, telefono: e.target.value })} className={inp} /><input type=â€œtelâ€ placeholder=â€œWhatsAppâ€ value={f.whatsapp || â€˜â€™} onChange={(e) => setF({ â€¦f, whatsapp: e.target.value })} className={inp} /></div><input type=â€œemailâ€ placeholder=â€œEmailâ€ value={f.email || â€˜â€™} onChange={(e) => setF({ â€¦f, email: e.target.value })} className={inp} /><input type=â€œtextâ€ placeholder=â€œNazionalitÃ â€ value={f.nazionalita || â€˜â€™} onChange={(e) => setF({ â€¦f, nazionalita: e.target.value })} className={inp} /><div className="grid grid-cols-2 gap-3"><input type=â€œnumberâ€ placeholder=â€œBudget Minâ€ value={f.budget_min || â€˜â€™} onChange={(e) => setF({ â€¦f, budget_min: e.target.value })} className={inp} /><input type=â€œnumberâ€ placeholder=â€œBudget Maxâ€ value={f.budget_max || â€˜â€™} onChange={(e) => setF({ â€¦f, budget_max: e.target.value })} className={inp} /></div><div className="grid grid-cols-2 gap-3"><select value={f.stato || â€˜nuovoâ€™} onChange={(e) => setF({ â€¦f, stato: e.target.value })} className={inp}>{clienteStati.map(s => <option key={s} value={s}>{s}</option>)}</select><input type=â€œtextâ€ placeholder=â€œFonteâ€ value={f.fonte || â€˜â€™} onChange={(e) => setF({ â€¦f, fonte: e.target.value })} className={inp} /></div><textarea placeholder=â€œNoteâ€ value={f.note || â€˜â€™} onChange={(e) => setF({ â€¦f, note: e.target.value })} className={`${inp} h-20`} /></div><div className="flex gap-3 mt-4"><button onClick={onClose} className="flex-1 bg-slate-700 text-white rounded-xl py-3">Annulla</button><button onClick={save} className="flex-1 bg-amber-500 text-slate-900 rounded-xl py-3 font-semibold">Salva</button></div></div></div>; }

function UserManagement({ users, loadUsers, createUser, updateUser, deleteUser, showUserModal, setShowUserModal, editingUser, setEditingUser, selectedUsers, toggleSelectUser, deleteSelectedUsers }) { const [copiedId, setCopiedId] = useState(null); const copy = (u) => { navigator.clipboard.writeText(`KeyPrime\n${getBaseUrl()}\n${u.username} / ${u.password}`); setCopiedId(u.id); setTimeout(() => setCopiedId(null), 2000); }; return <div><div className="flex justify-between items-center mb-4"><h2 className="text-lg font-semibold text-white">Utenti</h2><div className="flex gap-2">{selectedUsers.length > 0 && <button onClick={deleteSelectedUsers} className="bg-red-500 text-white rounded-lg px-3 py-2 flex items-center gap-1 text-sm"><Trash2 className="w-4 h-4" />{selectedUsers.length}</button>}<button onClick={() => { setEditingUser(null); setShowUserModal(true); }} className=â€œbg-amber-500 text-slate-900 rounded-lg px-3 py-2 flex items-center gap-1 text-sm font-semiboldâ€><UserPlus className="w-4 h-4" />Nuovo</button></div></div><div className="space-y-2">{users.map(u => <div key={u.id} className={`bg-slate-800 border rounded-xl p-3 ${selectedUsers.includes(u.id) ? 'border-amber-500' : 'border-slate-700'}`}><div className="flex items-center gap-3"><button onClick={() => toggleSelectUser(u.id)}>{selectedUsers.includes(u.id) ? <CheckSquare className="w-4 h-4 text-amber-400" /> : <Square className="w-4 h-4 text-slate-500" />}</button><div className="flex-1"><div className="flex items-center gap-2"><span className="text-white font-medium text-sm">{u.nome}</span><span className={`px-2 py-0.5 rounded text-xs ${u.ruolo === 'admin' ? 'bg-amber-500/20 text-amber-400' : u.ruolo === 'agente' ? 'bg-blue-500/20 text-blue-400' : 'bg-emerald-500/20 text-emerald-400'}`}>{u.ruolo}</span></div><div className="text-slate-400 text-xs mt-1">{u.username} / {u.password}{u.email && ` â€¢ ${u.email}`}</div></div><div className="flex gap-1"><button onClick={() => copy(u)} className=â€œbg-slate-700 text-white rounded-lg p-2â€>{copiedId === u.id ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}</button><button onClick={() => { setEditingUser(u); setShowUserModal(true); }} className=â€œbg-blue-500/20 text-blue-400 rounded-lg p-2â€><Edit2 className="w-4 h-4" /></button>{u.ruolo !== â€˜adminâ€™ && <button onClick={() => deleteUser(u.id)} className=â€œbg-red-500/20 text-red-400 rounded-lg p-2â€><Trash2 className="w-4 h-4" /></button>}</div></div></div>)}</div>{showUserModal && <UserModal user={editingUser} onClose={() => { setShowUserModal(false); setEditingUser(null); }} onSave={editingUser ? (d) => updateUser(editingUser.id, d) : createUser} />}</div>; }

function UserModal({ user, onClose, onSave }) { const [f, setF] = useState(user || { nome: â€˜â€™, username: â€˜â€™, password: â€˜â€™, email: â€˜â€™, ruolo: â€˜agenteâ€™, referente: â€˜Pellegrinoâ€™, attivo: true }); const save = async () => { if (!f.nome || !f.username || !f.password) { alert(â€˜Compila i campiâ€™); return; } const ok = await onSave(f); if (ok) onClose(); }; const inp = â€œw-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-white text-smâ€; return <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50"><div className="bg-slate-800 rounded-2xl p-6 max-w-md w-full border border-slate-700"><h3 className="text-lg font-semibold text-white mb-4">{user ? â€˜Modificaâ€™ : â€˜Nuovoâ€™} Utente</h3><div className="space-y-3"><input type=â€œtextâ€ placeholder=â€œNome *â€ value={f.nome} onChange={(e) => setF({ â€¦f, nome: e.target.value })} className={inp} /><input type=â€œemailâ€ placeholder=â€œEmailâ€ value={f.email || â€˜â€™} onChange={(e) => setF({ â€¦f, email: e.target.value })} className={inp} /><div className="grid grid-cols-2 gap-3"><input type=â€œtextâ€ placeholder=â€œUsername *â€ value={f.username} onChange={(e) => setF({ â€¦f, username: e.target.value })} className={inp} /><input type=â€œtextâ€ placeholder=â€œPassword *â€ value={f.password} onChange={(e) => setF({ â€¦f, password: e.target.value })} className={inp} /></div><div className="grid grid-cols-2 gap-3"><select value={f.ruolo} onChange={(e) => setF({ â€¦f, ruolo: e.target.value })} className={inp}><option value="agente">Agente</option><option value="segnalatore">Segnalatore</option></select><select value={f.referente} onChange={(e) => setF({ â€¦f, referente: e.target.value })} className={inp}><option value="Pellegrino">Pellegrino</option><option value="Giovanni">Giovanni</option></select></div>{user && <div className="flex items-center gap-3"><input type=â€œcheckboxâ€ id=â€œattâ€ checked={f.attivo} onChange={(e) => setF({ â€¦f, attivo: e.target.checked })} className=â€œw-4 h-4â€ /><label htmlFor="att" className="text-slate-300 text-sm">Attivo</label></div>}</div><div className="flex gap-3 mt-4"><button onClick={onClose} className="flex-1 bg-slate-700 text-white rounded-xl py-3">Annulla</button><button onClick={save} className="flex-1 bg-amber-500 text-slate-900 rounded-xl py-3 font-semibold">Salva</button></div></div></div>; }